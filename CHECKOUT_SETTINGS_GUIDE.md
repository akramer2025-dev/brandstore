# نظام التحكم في خيارات الدفع والاستلام

## نظرة عامة
تم إنشاء نظام شامل لتمكين المطور/الإداري من التحكم في خيارات الدفع والاستلام المتاحة للعملاء من خلال لوحة إعدادات سهلة الاستخدام.

## الملفات المُضافة/المُعدّلة

### ✅ الملفات الجديدة:
1. **`src/app/admin/settings/checkout/page.tsx`**
   - صفحة إعدادات الدفع والاستلام
   - واجهة مستخدم سهلة مع مفاتيح تبديل (switches)
   - التحقق من وجود خيار واحد على الأقل مفعّل

### ✅ الملفات المُعدّلة:
1. **`src/app/checkout/page.tsx`**
   - إضافة state للإعدادات
   - تحميل الإعدادات من قاعدة البيانات
   - إخفاء/إظهار خيارات الدفع والاستلام بناءً على الإعدادات
   - تحديد الخيار الافتراضي تلقائياً بناءً على الخيارات المفعّلة

## الميزات

### 1. طرق الاستلام (Delivery Methods)
يمكن التحكم في الخيارات التالية:
- ✅ **التوصيل للمنزل** (HOME_DELIVERY)
  - توصيل المنتجات إلى عنوان العميل
  - رسوم توصيل حسب المحافظة
  
- ✅ **الاستلام من المتجر** (STORE_PICKUP)
  - استلام من الفروع المتاحة
  - لا توجد رسوم توصيل
  - يتطلب دفعة مقدمة (حسب الإعدادات)

### 2. طرق الدفع (Payment Methods)
يمكن التحكم في الخيارات التالية:
- ✅ **الدفع عند الاستلام** (CASH_ON_DELIVERY)
  - الدفع نقداً عند استلام المنتج
  - إمكانية الفحص قبل الدفع
  
- ✅ **التحويل البنكي** (BANK_TRANSFER)
  - التحويل على محفظة إنستاباي
  - خصم 5% على الطلب
  - رفع صورة إيصال التحويل
  
- ✅ **المحفظة الإلكترونية** (E_WALLET_TRANSFER)
  - فودافون كاش
  - اتصالات كاش
  - وي باي (WE Pay)
  
- ✅ **الدفع بالتقسيط** (INSTALLMENT)
  - تقسيط على 4، 6، 12، أو 24 شهر
  - حاسبة تقسيط تلقائية

## إعدادات قاعدة البيانات

يتم حفظ الإعدادات في جدول `system_settings` بالمفاتيح التالية:

### طرق الاستلام:
```javascript
delivery_method_home_delivery    // 'true' أو 'false'
delivery_method_store_pickup     // 'true' أو 'false'
```

### طرق الدفع:
```javascript
payment_method_cash_on_delivery  // 'true' أو 'false'
payment_method_bank_transfer     // 'true' أو 'false'
payment_method_e_wallet          // 'true' أو 'false'
payment_method_installment       // 'true' أو 'false'
```

## كيفية الاستخدام

### 1. الوصول إلى صفحة الإعدادات
```
/admin/settings/checkout
```

### 2. تفعيل/تعطيل الخيارات
- كل خيار له مفتاح تبديل (switch)
- يمكن تفعيل/تعطيل أي خيار بنقرة واحدة
- يتم حفظ التغييرات بالضغط على زر "حفظ التغييرات"

### 3. الضمانات الأمنية
- **يجب تفعيل طريقة استلام واحدة على الأقل**
- **يجب تفعيل طريقة دفع واحدة على الأقل**
- عند محاولة إيقاف جميع الخيارات، سيظهر خطأ

## سلوك النظام

### عند تحميل صفحة Checkout:
1. يتم تحميل الإعدادات من قاعدة البيانات
2. يتم إخفاء الخيارات المعطلة
3. يتم تحديد الخيار الافتراضي:
   - إذا كانت طريقة واحدة فقط مفعّلة، يتم اختيارها تلقائياً
   - إذا كانت عدة طرق مفعّلة، يتم اختيار الأولى

### عند إيقاف جميع طرق الدفع:
- يظهر رسالة خطأ: "يجب تفعيل طريقة دفع واحدة على الأقل"
- لا يتم حفظ التغييرات

### عند إيقاف جميع طرق الاستلام:
- يظهر رسالة خطأ: "يجب تفعيل طريقة استلام واحدة على الأقل"
- لا يتم حفظ التغييرات

## الواجهة

### صفحة الإعدادات تتضمن:
- **Header**: عنوان الصفحة وزر الحفظ
- **تحذير**: ملاحظة هامة عن وجوب تفعيل خيار واحد على الأقل
- **قسم طرق الاستلام**: بطاقة تحتوي على جميع خيارات الاستلام
- **قسم طرق الدفع**: بطاقة تحتوي على جميع خيارات الدفع
- **ملخص الإعدادات**: عرض الخيارات المفعّلة حالياً

### كل خيار يحتوي على:
- أيقونة مميزة
- عنوان واضح
- وصف مختصر
- مفتاح تبديل (switch)
- مؤشر حالة (مُفَعَّل/غير مُفَعَّل)

## API Endpoints

### قراءة الإعدادات:
```javascript
GET /api/settings?keys=delivery_method_home_delivery,delivery_method_store_pickup,payment_method_cash_on_delivery,payment_method_bank_transfer,payment_method_e_wallet,payment_method_installment
```

### تحديث إعداد:
```javascript
POST /api/settings
Body: {
  key: "delivery_method_home_delivery",
  value: "true",
  description: "تفعيل التوصيل للمنزل"
}
```

## التحسينات المستقبلية المقترحة

### 1. إضافة المزيد من الخيارات:
- تحديد الحد الأدنى لقيمة الطلب لكل طريقة دفع
- تحديد رسوم إضافية لبعض طرق الدفع
- تحديد المحافظات المتاحة لكل طريقة استلام

### 2. تحسينات في الواجهة:
- إضافة معاينة مباشرة لصفحة Checkout
- إحصائيات عن استخدام كل طريقة دفع/استلام
- سجل تغييرات الإعدادات

### 3. إشعارات:
- إشعار العملاء عند تغيير الخيارات المتاحة
- إشعار الإداري عند محاولة تعطيل جميع الخيارات

## الأمان

- ✅ يتطلب تسجيل دخول كـ ADMIN للوصول إلى صفحة الإعدادات
- ✅ التحقق من صحة البيانات في الـ Frontend والـ Backend
- ✅ ضمان وجود خيار واحد على الأقل مفعّل

## الاختبار

### اختبار الوظائف الأساسية:
```bash
# 1. تشغيل المشروع
npm run dev

# 2. الدخول إلى صفحة الإعدادات
http://localhost:3000/admin/settings/checkout

# 3. اختبار السيناريوهات:
- تغيير الإعدادات وحفظها
- محاولة إيقاف جميع الخيارات
- التحقق من تأثير التغييرات على صفحة Checkout
```

### سيناريوهات الاختبار:
1. ✅ تفعيل/تعطيل طرق الاستلام
2. ✅ تفعيل/تعطيل طرق الدفع
3. ✅ حفظ الإعدادات
4. ✅ التحقق من الإعدادات في صفحة Checkout
5. ✅ محاولة إيقاف جميع الخيارات (يجب أن يفشل)

## المشاكل المحتملة وحلولها

### 1. الخيارات لا تظهر في صفحة Checkout:
**الحل**: تأكد من أن الإعدادات محفوظة في قاعدة البيانات بشكل صحيح

### 2. جميع الخيارات معطلة:
**الحل**: قم بحذف الإعدادات من قاعدة البيانات، سيتم استخدام القيم الافتراضية (جميع الخيارات مفعّلة)

### 3. خطأ عند الحفظ:
**الحل**: تحقق من صلاحيات المستخدم وأنه ADMIN

## الدعم الفني

للمساعدة أو الإبلاغ عن مشاكل:
- راجع هذا الملف أولاً
- تحقق من logs النظام
- اتصل بفريق التطوير

---

**تم الإنشاء**: ديسمبر 2024  
**آخر تحديث**: ديسمبر 2024  
**الحالة**: ✅ جاهز للاستخدام
