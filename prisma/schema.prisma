generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String         @id @default(cuid())
  name             String?
  username         String?        @unique
  email            String?        @unique
  emailVerified    DateTime?
  image            String?
  password         String?
  role             UserRole       @default(CUSTOMER)
  phone            String?
  address          String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  accounts         Account[]
  deliveryStaff    DeliveryStaff?
  messagesReceived Message[]      @relation("ReceivedMessages")
  messagesSent     Message[]      @relation("SentMessages")
  orders           Order[]
  reviews          Review[]
  sessions         Session[]
  vendor           Vendor?
  wishlistItems    WishlistItem[]
  savedAddresses   SavedAddress[] // العناوين المحفوظة

  @@map("users")
}

// العناوين المحفوظة للعملاء
model SavedAddress {
  id              String   @id @default(cuid())
  userId          String
  title           String   // مثل: المنزل، العمل، الخ
  fullName        String   // الاسم الكامل
  phone           String   // رقم الهاتف
  alternativePhone String? // رقم هاتف بديل
  governorate     String   // المحافظة
  city            String   // المدينة/المركز
  district        String   // الحي/المنطقة
  street          String   // اسم الشارع
  buildingNumber  String?  // رقم المبنى/العمارة
  floorNumber     String?  // رقم الطابق
  apartmentNumber String?  // رقم الشقة
  landmark        String?  // أقرب معلم
  postalCode      String?  // الرمز البريدي
  isDefault       Boolean  @default(false) // العنوان الافتراضي
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("saved_addresses")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Vendor {
  id                 String         @id @default(cuid())
  userId             String         @unique
  businessName       String?        @default("")
  businessNameAr     String?        @default("")
  businessType       String?        @default("store")
  storeName          String?        @default("")
  storeNameAr        String?        @default("")
  storeDescription   String?
  storeDescriptionAr String?
  logo               String?
  banner             String?
  phone              String?
  alternativePhone   String?
  whatsapp           String?
  address            String?
  city               String?
  region             String?
  postalCode         String?
  description        String?
  descriptionAr      String?
  category           String?
  subCategory        String?
  yearsOfExperience  Int            @default(0)
  commissionRate     Float          @default(15)
  // رأس المال
  capitalBalance     Float          @default(0)  // رصيد رأس المال الحالي
  // البيانات البنكية (اختيارية)
  bankName           String?
  accountNumber      String?
  accountHolderName  String?
  bankAccountName    String?
  bankAccountNumber  String?
  iban               String?
  // المحافظ الإلكترونية (اختيارية)
  instaPay           String?
  etisalatCash       String?        // اتصالات كاش
  vodafoneCash       String?        // فودافون كاش
  wePay              String?        // وي باي
  // الأوراق الرسمية (اختيارية)
  commercialRegister String?
  taxCard            String?
  nationalId         String?
  businessLicense    String?
  isApproved         Boolean        @default(false)
  isActive           Boolean        @default(true)
  rating             Float          @default(0)
  totalSales         Int            @default(0)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  orders             Order[]
  products           Product[]
  payouts            VendorPayout[]
  partners           PartnerCapital[]
  inventoryItems     InventoryItem[]
  expenses           VendorExpense[]
  vouchers           VendorVoucher[]
  sales              Sale[]
  purchases          Purchase[]
  user               User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("vendors")
}

model VendorPayout {
  id        String       @id @default(cuid())
  vendorId  String
  amount    Float
  status    PayoutStatus @default(PENDING)
  method    String
  reference String?
  notes     String?
  paidAt    DateTime?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  vendor    Vendor       @relation(fields: [vendorId], references: [id])

  @@map("vendor_payouts")
}

model Category {
  id          String    @id @default(cuid())
  name        String
  nameAr      String
  description String?
  image       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]

  @@map("categories")
}

model Product {
  id              String         @id @default(cuid())
  name            String
  nameAr          String
  description     String?
  descriptionAr   String?
  price           Float
  originalPrice   Float?
  categoryId      String
  images          String?
  stock           Int            @default(0)
  isActive        Boolean        @default(true)
  vendorId        String?
  isOwnProduct    Boolean        @default(false)
  isFlashDeal     Boolean        @default(false)
  flashDealEndsAt DateTime?
  badge           String?
  soldCount       Int            @default(0)
  viewCount       Int            @default(0)
  // حقول جديدة
  sizes           String?        // مقاسات متاحة (مفصولة بفواصل): "S,M,L,XL"
  colors          String?        // ألوان متاحة (مفصولة بفواصل): "أحمر,أزرق,أسود"
  saleType        SaleType       @default(SINGLE) // نوع البيع: قطعة واحدة أو عرض
  bundleProducts  String?        // المنتجات المرفقة في العرض (IDs مفصولة بفواصل)
  bundleDiscount  Float?         // خصم العرض بالنسبة المئوية
  platformCommission Float       @default(5) // عمولة المتجر (افتراضي 5%)
  isVisible       Boolean        @default(true) // يظهر في المتجر أم لا
  productionCost  Float?         // تكلفة الإنتاج (للأرباح)
  
  // ============ نظام المنتجات الوسيط (Consignment/Dropship) ============
  productSource   ProductSource  @default(OWNED)     // مصدر المنتج: مملوك أو وسيط
  supplierName    String?        // اسم المورد/المحل الأصلي
  supplierPhone   String?        // رقم هاتف المورد
  supplierCost    Float?         // سعر المنتج من المورد (المبلغ المستحق له)
  isSupplierPaid  Boolean        @default(false)     // هل تم الدفع للمورد
  supplierPaidAt  DateTime?      // تاريخ الدفع للمورد
  supplierNotes   String?        // ملاحظات عن المورد
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  fabricPieces    FabricPiece[]
  orderItems      OrderItem[]
  productions     Production[]
  category        Category       @relation(fields: [categoryId], references: [id])
  vendor          Vendor?        @relation(fields: [vendorId], references: [id])
  reviews         Review[]
  wishlistItems   WishlistItem[]
  inventoryItems  InventoryItem[]
  supplierPayments SupplierPayment[]

  @@map("products")
}

model Fabric {
  id              String        @id @default(cuid())
  name            String
  nameAr          String
  type            String
  color           String
  purchasePrice   Float
  totalLength     Float
  usedLength      Float         @default(0)
  availableLength Float
  supplier        String?
  purchaseDate    DateTime      @default(now())
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  fabricPieces    FabricPiece[]

  @@map("fabrics")
}

model FabricPiece {
  id           String   @id @default(cuid())
  fabricId     String
  productId    String
  lengthUsed   Float
  quantity     Int
  costPerPiece Float
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  fabric       Fabric   @relation(fields: [fabricId], references: [id])
  product      Product  @relation(fields: [productId], references: [id])

  @@map("fabric_pieces")
}

model Order {
  id               String            @id @default(cuid())
  orderNumber      String            @unique @default(cuid())
  customerId       String
  vendorId         String?
  status           OrderStatus       @default(PENDING)
  paymentStatus    PaymentStatus     @default(PENDING)
  paymentMethod    PaymentMethod     @default(CASH_ON_DELIVERY)
  eWalletType      String?           // نوع المحفظة: etisalat_cash, vodafone_cash, we_pay
  totalAmount      Float
  deliveryFee      Float             @default(0)
  finalAmount      Float
  installmentId    String?           @unique
  deliveryStaffId  String?
  deliveryAddress  String
  deliveryPhone    String
  customerNotes    String?
  rejectionReason  String?
  inspectionResult InspectionResult?
  deletedAt        DateTime?         // Soft Delete - تاريخ الحذف (null = موجود)
  deletedBy        String?           // من قام بالحذف (userId)
  deletedReason    String?           // سبب الحذف
  // ✨ حقول جديدة لنظام التوصيل المتطور
  deliveryMethod   DeliveryMethod    @default(HOME_DELIVERY)
  pickupLocation   String?           // عنوان المتجر للاستلام
  governorate      String?           // المحافظة (للتوصيل المنزلي)
  downPayment      Float?            // الدفعة المقدمة
  remainingAmount  Float?            // المبلغ المتبقي
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  installmentPlan  InstallmentPlan?
  items            OrderItem[]
  customer         User              @relation(fields: [customerId], references: [id])
  deliveryStaff    DeliveryStaff?    @relation(fields: [deliveryStaffId], references: [id])
  vendor           Vendor?           @relation(fields: [vendorId], references: [id])

  @@map("orders")
}

model InstallmentPlan {
  id             String               @id @default(cuid())
  orderId        String               @unique
  totalAmount    Float
  downPayment    Float
  monthlyAmount  Float
  numberOfMonths Int
  interestRate   Float                @default(0)
  status         InstallmentStatus    @default(ACTIVE)
  startDate      DateTime             @default(now())
  endDate        DateTime
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  payments       InstallmentPayment[]
  order          Order                @relation(fields: [orderId], references: [id])

  @@map("installment_plans")
}

model InstallmentPayment {
  id            String                   @id @default(cuid())
  planId        String
  amount        Float
  dueDate       DateTime
  paidDate      DateTime?
  status        InstallmentPaymentStatus @default(PENDING)
  paymentMethod String?
  reference     String?
  notes         String?
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt
  plan          InstallmentPlan          @relation(fields: [planId], references: [id])

  @@map("installment_payments")
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Float
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model DeliveryStaff {
  id                   String    @id @default(cuid())
  userId               String?   @unique
  name                 String?   @default("")
  phone                String    @unique
  alternativePhone     String?
  whatsapp             String?
  email                String?   @unique
  password             String?   @default("")
  address              String?
  city                 String?
  region               String?
  vehicleType          String?
  vehicleNumber        String?
  drivingLicense       String?
  nationalId           String?
  // البيانات البنكية (اختيارية)
  bankName             String?
  accountNumber        String?
  iban                 String?
  accountHolderName    String?
  // المحافظ الإلكترونية (اختيارية)
  instaPay             String?
  etisalatCash         String?
  vodafoneCash         String?
  wePay                String?
  isActive             Boolean   @default(true)
  isAvailable          Boolean   @default(true)
  isApproved           Boolean   @default(false)
  currentLat           Float?
  currentLng           Float?
  lastLocationUpdate   DateTime?
  totalDeliveries      Int       @default(0)
  successfulDeliveries Int       @default(0)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders               Order[]

  @@map("delivery_staff")
}

model InventoryLog {
  id          String   @id @default(cuid())
  productId   String
  productName String
  changeType  String
  quantity    Int
  stockBefore Int
  stockAfter  Int
  notes       String?
  createdAt   DateTime @default(now())

  @@map("inventory_logs")
}

model Review {
  id         String   @id @default(cuid())
  productId  String
  userId     String
  rating     Int
  comment    String?
  isApproved Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

model RawMaterial {
  id             String               @id @default(cuid())
  name           String
  nameAr         String
  category       MaterialCategory
  unit           String
  quantity       Float
  minQuantity    Float                @default(10)
  unitPrice      Float
  totalValue     Float
  supplier       String?
  location       String?
  lastPurchase   DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  movements      MaterialMovement[]
  productionUses ProductionMaterial[]

  @@map("raw_materials")
}

model MaterialMovement {
  id          String       @id @default(cuid())
  materialId  String
  type        MovementType
  quantity    Float
  unitPrice   Float?
  totalCost   Float?
  previousQty Float
  newQty      Float
  reference   String?
  notes       String?
  createdBy   String?
  createdAt   DateTime     @default(now())
  material    RawMaterial  @relation(fields: [materialId], references: [id])

  @@map("material_movements")
}

model Production {
  id                String               @id @default(cuid())
  productionNumber  String               @unique @default(cuid())
  productId         String
  quantity          Int
  laborCost         Float                @default(0)
  overheadCost      Float                @default(0)
  totalMaterialCost Float
  totalCost         Float
  costPerUnit       Float
  status            ProductionStatus     @default(PLANNED)
  startDate         DateTime?
  completionDate    DateTime?
  notes             String?
  createdBy         String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  materials         ProductionMaterial[]
  product           Product              @relation(fields: [productId], references: [id])

  @@map("productions")
}

model ProductionMaterial {
  id           String      @id @default(cuid())
  productionId String
  materialId   String
  quantityUsed Float
  unitCost     Float
  totalCost    Float
  createdAt    DateTime    @default(now())
  material     RawMaterial @relation(fields: [materialId], references: [id])
  production   Production  @relation(fields: [productionId], references: [id], onDelete: Cascade)

  @@map("production_materials")
}

model PaymentVoucher {
  id              String                  @id @default(cuid())
  voucherNumber   String                  @unique
  type            VoucherType
  amount          Float
  paymentMethod   AccountingPaymentMethod
  recipientName   String?
  payerName       String?
  category        ExpenseCategory?
  reference       String?
  description     String?
  attachments     String?
  status          VoucherStatus           @default(PENDING)
  approvedBy      String?
  approvedAt      DateTime?
  paidBy          String?
  transactionDate DateTime                @default(now())
  createdBy       String?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  @@map("payment_vouchers")
}

model MarketingCampaign {
  id             String         @id @default(cuid())
  name           String
  type           CampaignType
  platform       String?
  budget         Float
  spent          Float          @default(0)
  startDate      DateTime
  endDate        DateTime?
  status         CampaignStatus @default(ACTIVE)
  targetAudience String?
  keywords       String?
  adCopy         String?
  impressions    Int            @default(0)
  clicks         Int            @default(0)
  conversions    Int            @default(0)
  ctr            Float          @default(0)
  cpc            Float          @default(0)
  roi            Float          @default(0)
  notes          String?
  createdBy      String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@map("marketing_campaigns")
}

model SeoKeyword {
  id           String    @id @default(cuid())
  keyword      String
  searchVolume Int?
  difficulty   Int?
  currentRank  Int?
  targetRank   Int?
  url          String?
  status       String?
  lastChecked  DateTime?
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("seo_keywords")
}

model WebsiteAnalytics {
  id                 String   @id @default(cuid())
  date               DateTime @unique
  pageViews          Int      @default(0)
  uniqueVisitors     Int      @default(0)
  bounceRate         Float    @default(0)
  avgSessionDuration Float    @default(0)
  topPages           String?
  topProducts        String?
  trafficSources     String?
  conversions        Int      @default(0)
  revenue            Float    @default(0)
  createdAt          DateTime @default(now())

  @@map("website_analytics")
}

model WishlistItem {
  id               String   @id @default(cuid())
  userId           String
  productId        String
  notifyOnLowStock Boolean  @default(true)
  createdAt        DateTime @default(now())
  product          Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("wishlist_items")
}

model Message {
  id             String   @id @default(cuid())
  content        String
  senderId       String
  receiverId     String?
  isRead         Boolean  @default(false)
  isAdminMessage Boolean  @default(false)
  orderId        String?
  attachmentUrl  String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  receiver       User?    @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  sender         User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@map("messages")
}

model SiteSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  type        String   @default("text")
  category    String   @default("general")
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("site_settings")
}

model SliderImage {
  id           String   @id @default(cuid())
  title        String
  titleAr      String?
  subtitle     String?
  subtitleAr   String?
  imageUrl     String
  link         String?
  buttonText   String?
  buttonTextAr String?
  order        Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("slider_images")
}

enum UserRole {
  ADMIN
  CUSTOMER
  DELIVERY_STAFF
  VENDOR
  MANUFACTURER
}

enum SaleType {
  SINGLE    // قطعة واحدة
  BUNDLE    // عرض (مع منتجات أخرى)
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentMethod {
  CASH_ON_DELIVERY
  BANK_TRANSFER
  E_WALLET_TRANSFER
  INSTALLMENT_4
  INSTALLMENT_6
  INSTALLMENT_12
  INSTALLMENT_24
}

enum InstallmentStatus {
  ACTIVE
  COMPLETED
  DEFAULTED
  CANCELLED
}

enum InstallmentPaymentStatus {
  PENDING
  PAID
  LATE
  FAILED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  OUT_FOR_DELIVERY
  DELIVERED
  REJECTED
  CANCELLED
}

enum DeliveryMethod {
  HOME_DELIVERY    // توصيل للمنزل
  STORE_PICKUP     // استلام من المتجر
}

enum PaymentStatus {
  PENDING
  PAID
  REJECTED
  DELIVERY_FEE_ONLY
}

enum InspectionResult {
  ACCEPTED
  REJECTED
}

enum MaterialCategory {
  FABRIC
  THREAD
  BUTTON
  ZIPPER
  ACCESSORY
  PACKAGING
  OTHER
}

enum MovementType {
  PURCHASE
  PRODUCTION
  RETURN
  ADJUSTMENT
  DAMAGE
  TRANSFER
}

enum ProductionStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum VoucherType {
  RECEIPT
  PAYMENT
}

enum AccountingPaymentMethod {
  CASH
  BANK_TRANSFER
  CHECK
  CARD
  MOBILE_WALLET
}

enum ExpenseCategory {
  MATERIALS
  SALARIES
  RENT
  UTILITIES
  MARKETING
  TRANSPORT
  MAINTENANCE
  OTHER
}

enum VoucherStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum CampaignType {
  SEO
  GOOGLE_ADS
  FACEBOOK_ADS
  INSTAGRAM_ADS
  EMAIL
  INFLUENCER
  CONTENT
  OTHER
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
}

// نظام الشركاء المتعددين (Multi-Partner System)
model PartnerCapital {
  id               String              @id @default(cuid())
  vendorId         String
  partnerName      String              // اسم الشريك
  partnerType      String              @default("OWNER") // نوع الشريك: OWNER, PARTNER, etc
  capitalAmount    Float               // المبلغ المساهم به
  initialAmount    Float               @default(0) // المبلغ الأولي
  currentAmount    Float               @default(0) // المبلغ الحالي
  capitalPercent   Float               // نسبة المساهمة من إجمالي رأس المال
  joinDate         DateTime            @default(now())
  isActive         Boolean             @default(true)
  notes            String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  vendor           Vendor              @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  profitShares     ProfitDistribution[]

  @@map("partner_capitals")
}

// توزيع الأرباح على الشركاء
model ProfitDistribution {
  id              String         @id @default(cuid())
  partnerId       String
  vendorId        String
  periodStart     DateTime
  periodEnd       DateTime
  totalRevenue    Float          // إجمالي الإيرادات
  totalCost       Float          // إجمالي التكاليف
  totalExpenses   Float          // إجمالي المصروفات
  netProfit       Float          // صافي الربح
  partnerShare    Float          // حصة الشريك من الربح
  isPaid          Boolean        @default(false)
  paidAt          DateTime?
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  partner         PartnerCapital @relation(fields: [partnerId], references: [id])

  @@map("profit_distributions")
}

// المشتريات (Purchases)
model Purchase {
  id                  String        @id @default(cuid())
  vendorId            String
  productName         String
  productNameAr       String?
  quantity            Float
  unitCost            Float         // سعر الوحدة (الشراء)
  totalCost           Float         // إجمالي التكلفة
  supplier            String?       // المورد
  supplierPhone       String?
  purchaseDate        DateTime      @default(now())
  receiptNumber       String?       // رقم الفاتورة
  receiptImage        String?       // صورة الفاتورة
  notes               String?
  fromCapital         Boolean       @default(true)  // من رأس المال أم بالنيابة
  sellingPrice        Float?        // سعر البيع المتوقع
  commissionFromStore Boolean       @default(true)  // هل يحسب عمولة المتجر 5%
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  vendor              Vendor        @relation(fields: [vendorId], references: [id])
  sales               Sale[]
  inventoryItemId     String?
  inventoryItem       InventoryItem? @relation(fields: [inventoryItemId], references: [id])

  @@map("purchases")
}

// المبيعات (Sales)
model Sale {
  id             String    @id @default(cuid())
  vendorId       String
  purchaseId     String?
  productName    String
  productNameAr  String?
  quantity       Float
  unitPrice      Float     // سعر البيع للوحدة
  totalAmount    Float     // إجمالي المبيعات
  costPrice      Float?    // سعر التكلفة للوحدة
  profit         Float?    // الربح
  saleDate       DateTime  @default(now())
  customerName   String?
  customerPhone  String?
  invoiceNumber  String?
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  vendor         Vendor    @relation(fields: [vendorId], references: [id])
  purchase       Purchase? @relation(fields: [purchaseId], references: [id])
  returns        Return[]

  @@map("sales")
}

// المخزون (Inventory)
model InventoryItem {
  id                String     @id @default(cuid())
  vendorId          String
  productId         String?
  productName       String
  productNameAr     String?
  totalPurchased    Float      @default(0) // إجمالي الكمية المشتراة
  totalSold         Float      @default(0) // إجمالي الكمية المباعة
  currentStock      Float      @default(0) // المخزون الحالي
  minStockAlert     Float      @default(10) // حد التنبيه
  unitCost          Float      // متوسط سعر التكلفة
  lastPurchaseDate  DateTime?
  lastSaleDate      DateTime?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  vendor            Vendor     @relation(fields: [vendorId], references: [id])
  product           Product?   @relation(fields: [productId], references: [id])
  purchases         Purchase[]

  @@map("inventory_items")
}

// المصروفات (Expenses)
model VendorExpense {
  id             String       @id @default(cuid())
  vendorId       String
  expenseType    ExpenseType
  amount         Float
  vendor         Vendor       @relation(fields: [vendorId], references: [id])
  description    String
  descriptionAr  String?
  expenseDate    DateTime     @default(now())
  receiptImage   String?
  receiptNumber  String?      // رقم الفاتورة المرتبطة (للربط مع المشتريات)
  isPaid         Boolean      @default(true)
  paidBy         String?      // من دفع (اسم الشخص)
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("vendor_expenses")
}

enum ExpenseType {
  SHIPPING       // شحن
  PACKAGING      // تغليف
  MARKETING      // تسويق
  OPERATION      // تشغيل
  SALARY         // رواتب
  RENT           // إيجار
  UTILITIES      // مرافق (كهرباء، ماء، إنترنت)
  MAINTENANCE    // صيانة
  TRANSPORTATION // مواصلات ومشاوير
  OTHER          // متنوعة
}

// السندات (Vouchers)
model VendorVoucher {
  id             String        @id @default(cuid())
  vendorId       String
  voucherType    VoucherType
  voucherNumber  String        @unique
  amount         Float
  description    String
  descriptionAr  String?
  recipientName  String?       // المستلم أو الدافع
  voucherDate    DateTime      @default(now())
  voucherImage   String?       // صورة السند
  status         VoucherStatus @default(PENDING)
  approvedBy     String?
  approvedAt     DateTime?
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  vendor         Vendor        @relation(fields: [vendorId], references: [id])

  @@map("vendor_vouchers")
}

// المرتجعات (Returns)
model Return {
  id             String      @id @default(cuid())
  vendorId       String
  saleId         String?
  productName    String
  productNameAr  String?
  quantity       Float
  unitPrice      Float
  totalAmount    Float
  reason         String
  reasonAr       String?
  returnDate     DateTime    @default(now())
  status         ReturnStatus @default(PENDING)
  returnedToStock Boolean    @default(false) // هل تم إعادته للمخزون
  refundAmount   Float?
  customerName   String?
  notes          String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  sale           Sale?       @relation(fields: [saleId], references: [id])

  @@map("returns")
}

enum ReturnStatus {
  PENDING        // قيد المراجعة
  APPROVED       // تمت الموافقة
  REJECTED       // مرفوض
  REFUNDED       // تم الاسترداد
  CANCELLED      // ملغي
}

// ============ نظام مصادر المنتجات ============
enum ProductSource {
  OWNED          // منتج مملوك - تم شراؤه من رأس المال
  CONSIGNMENT    // منتج وسيط - من محل آخر (لا يخصم من رأس المال)
  DROPSHIP       // دروبشيب - شحن مباشر من المورد
}

// ============ مدفوعات الموردين (Supplier Payments) ============
model SupplierPayment {
  id              String        @id @default(cuid())
  vendorId        String
  productId       String?       // المنتج المرتبط
  orderId         String?       // الطلب المرتبط
  supplierName    String        // اسم المورد
  supplierPhone   String?       // رقم هاتف المورد
  amountDue       Float         // المبلغ المستحق
  amountPaid      Float         @default(0) // المبلغ المدفوع
  profit          Float         @default(0) // الربح (سعر البيع - سعر المورد)
  status          PaymentDueStatus @default(PENDING)
  paidAt          DateTime?     // تاريخ الدفع
  paymentMethod   String?       // طريقة الدفع
  paymentNotes    String?       // ملاحظات الدفع
  notes           String?       // ملاحظات إضافية
  saleDate        DateTime      @default(now()) // تاريخ البيع
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  product         Product?      @relation(fields: [productId], references: [id])

  @@map("supplier_payments")
}

enum PaymentDueStatus {
  PENDING        // معلق - لم يتم الدفع بعد
  PARTIAL        // دفع جزئي
  PAID           // تم الدفع بالكامل
  CANCELLED      // ملغي
}

// ============ معاملات رأس المال (Capital Transactions) ============
model CapitalTransaction {
  id              String              @id @default(cuid())
  vendorId        String
  partnerId       String?             // الشريك (اختياري)
  orderId         String?             // الطلب المرتبط
  type            CapitalTransactionType
  amount          Float               // المبلغ
  balanceBefore   Float               // الرصيد قبل المعاملة
  balanceAfter    Float               // الرصيد بعد المعاملة
  description     String              // وصف المعاملة
  descriptionAr   String?             // وصف بالعربي
  referenceType   String?             // نوع المرجع (order, sale, purchase, etc.)
  referenceId     String?             // ID المرجع
  notes           String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@map("capital_transactions")
}

enum CapitalTransactionType {
  DEPOSIT        // إيداع رأس مال
  WITHDRAWAL     // سحب من رأس المال
  PURCHASE       // شراء بضاعة (خصم)
  SALE_PROFIT    // ربح من بيع (إضافة)
  CONSIGNMENT_PROFIT // ربح من منتج وسيط (إضافة)
  EXPENSE        // مصروف (خصم)
  REFUND         // استرداد/مرتجع
  ADJUSTMENT     // تعديل يدوي
}

// ============ نظام مناطق التوصيل ============
model DeliveryZone {
  id            String   @id @default(cuid())
  governorate   String   @unique // اسم المحافظة
  deliveryFee   Float    // رسوم التوصيل
  minOrderValue Float    @default(0) // الحد الأدنى لقيمة الطلب
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("delivery_zones")
}

// ============ إعدادات النظام ============
model SystemSettings {
  id          String   @id @default(cuid())
  key         String   @unique // مفتاح الإعداد
  value       String   // القيمة
  description String?  // وصف الإعداد
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

// ============ نظام الإشعارات ============
model VendorNotification {
  id          String   @id @default(cuid())
  vendorId    String   // معرف الشريك
  type        NotificationType // نوع الإشعار
  title       String   // عنوان الإشعار
  message     String   // نص الإشعار
  orderId     String?  // معرف الطلب (إن وجد)
  isRead      Boolean  @default(false) // هل تم قراءته
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("vendor_notifications")
  @@index([vendorId, isRead])
}

enum NotificationType {
  NEW_ORDER      // طلب جديد
  ORDER_STATUS   // تحديث حالة الطلب
  LOW_STOCK      // مخزون منخفض
  NEW_MESSAGE    // رسالة جديدة
  SYSTEM         // إشعار نظام
}

// ============ نظام المستخدمين الفرعيين ============
model SubUser {
  id          String       @id @default(cuid())
  vendorId    String       // البائع الرئيسي
  name        String       // اسم المستخدم الفرعي
  email       String       @unique // البريد الإلكتروني
  password    String       // كلمة المرور المشفرة
  phone       String?      // رقم الهاتف
  role        SubUserRole  @default(CASHIER) // الدور
  permissions String[]     // الصلاحيات الإضافية
  isActive    Boolean      @default(true)  // هل المستخدم نشط
  lastLogin   DateTime?    // آخر تسجيل دخول
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  // سجل النشاط
  activityLogs SubUserActivityLog[]

  @@map("sub_users")
  @@index([vendorId])
}

// أنواع أدوار المستخدمين الفرعيين
enum SubUserRole {
  CASHIER       // كاشير نقطة البيع فقط
  ACCOUNTANT    // محاسب - يرى التقارير المالية
  INVENTORY     // مسؤول المخزون
  SALES         // مندوب مبيعات
  MANAGER       // مدير - صلاحيات كاملة ماعدا الإعدادات الحساسة
}

// سجل نشاط المستخدمين الفرعيين
model SubUserActivityLog {
  id          String   @id @default(cuid())
  subUserId   String
  action      String   // نوع العملية (login, sale, refund, etc.)
  details     String?  // تفاصيل إضافية
  ipAddress   String?  // عنوان IP
  createdAt   DateTime @default(now())
  
  subUser     SubUser  @relation(fields: [subUserId], references: [id], onDelete: Cascade)

  @@map("sub_user_activity_logs")
  @@index([subUserId, createdAt])
}

// ============ سجل نشاط البائع الرئيسي ============
model ActivityLog {
  id          String   @id @default(cuid())
  vendorId    String   // البائع
  action      String   // نوع العملية
  details     String?  // تفاصيل إضافية
  userName    String   // اسم المستخدم الذي قام بالعملية
  userRole    String   // دور المستخدم
  ipAddress   String?  // عنوان IP
  createdAt   DateTime @default(now())

  @@map("activity_logs")
  @@index([vendorId, createdAt])
  @@index([action])
}
