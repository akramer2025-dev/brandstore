# ุฏููู workflow ุงูุทูุจุงุช ูุงูุญุณุงุจุงุช ุงููุงููุฉ

## ๐ ูุฑุงุญู ุงูุทูุจ (Order Lifecycle)

### 1๏ธโฃ PENDING (ููุฏ ุงูุงูุชุธุงุฑ)
**ูุงุฐุง ูุญุฏุซ:**
- ุงูุนููู ูุถุน ุงูุทูุจ ูู ุงููููุน
- ุงููุธุงู ูุฑุจุท ุงูุทูุจ ุจุงูุดุฑูู ุชููุงุฆููุง ุนู ุทุฑูู `vendorId`
- ุชุธูุฑ ุฅุดุนุงุฑุงุช ุจุฑุชูุงููุฉ ูู ููุญุฉ ุงูุดุฑูู
- **ูุง ูุชู ุฎุตู ุงููุฎุฒูู ุจุนุฏ**
- **ูุง ูุชู ุชุญุฏูุซ ุฑุฃุณ ุงููุงู**

**ุฅุฌุฑุงุกุงุช ุงูุดุฑูู:**
- ูุฑุงุฌุนุฉ ุชูุงุตูู ุงูุทูุจ
- ุงูุชุฃูุฏ ูู ุชููุฑ ุงูููุชุฌุงุช
- ูุจูู ุฃู ุฑูุถ ุงูุทูุจ

---

### 2๏ธโฃ CONFIRMED (ุชู ุงูุชุฃููุฏ)
**ูุงุฐุง ูุญุฏุซ:**
- ุงูุดุฑูู ูุคูุฏ ุงูุทูุจ
- ูุชู ุญุฌุฒ ุงูููุชุฌุงุช (Stock Reserved)
- **ูุชู ุฎุตู ุงููููุงุช ูู ุงููุฎุฒูู**
- ูุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ููุนููู

**ุงูุชุฃุซูุฑ ุนูู ุงููุฎุฒูู:**
```typescript
// ููู ููุชุฌ ูู ุงูุทูุจ
product.stock = product.stock - quantity
```

**ุงูุชุฃุซูุฑ ุนูู ุฑุฃุณ ุงููุงู:**
- **ูุง ููุฌุฏ ุชุบููุฑ ุจุนุฏ** - ุงููุงู ูู ููุณุชูู

---

### 3๏ธโฃ PREPARING (ููุฏ ุงูุชุญุถูุฑ)
**ูุงุฐุง ูุญุฏุซ:**
- ุงูุดุฑูู ูุญุถุฑ ุงูููุชุฌุงุช ููุดุญู
- ูุชู ุชุฌููุฒ ุงูุชุบููู
- **ูุง ุชูุฌุฏ ุชุบููุฑุงุช ูุงููุฉ**

**ุฅุฌุฑุงุกุงุช ุงูุดุฑูู:**
- ุชุฌููุฒ ุงูููุชุฌุงุช
- ูุญุต ุงูุฌูุฏุฉ
- ุชุญุถูุฑ ุงููุงุชูุฑุฉ

---

### 4๏ธโฃ OUT_FOR_DELIVERY (ุฌุงุฑู ุงูุชูุตูู)
**ูุงุฐุง ูุญุฏุซ:**
- ุชุนููู ููุฏูุจ ุงูุชูุตูู
- ุงูููุชุฌุงุช ูู ุงูุทุฑูู ููุนููู
- **ูุง ุชูุฌุฏ ุชุบููุฑุงุช ูุงููุฉ ุจุนุฏ**

**ูุนูููุงุช ุงูุชูุตูู:**
- ุงุณู ุงูููุฏูุจ
- ุฑูู ุงููุงุชู
- ุงููููุน ุงูุญุงูู (ุฅู ููุฌุฏ)

---

### 5๏ธโฃ DELIVERED (ุชู ุงูุชูุตูู) โ
**ูุงุฐุง ูุญุฏุซ:**
ููุง ุชุญุฏุซ **ุฌููุน ุงูุนูููุงุช ุงููุงููุฉ**!

#### ุฃ. ุญุณุงุจ ุงูุนูููุงุช
```typescript
// ูุซุงู: ุทูุจ ุจูููุฉ 1000 ุฌ.ู
const subtotal = 1000;                    // ุงููุฌููุน ุงููุฑุนู
const storeCommission = subtotal * 0.05;  // 50 ุฌ.ู (5%)
const vendorEarnings = subtotal * 0.95;   // 950 ุฌ.ู (95%)
```

#### ุจ. ุญุณุงุจ ุงูุฃุฑุจุงุญ
```typescript
// ุญุณุงุจ ุชูููุฉ ุงูุฅูุชุงุฌ
const totalProductionCost = orderItems.reduce((sum, item) => {
  return sum + (item.product.productionCost * item.quantity);
}, 0);

// ุตุงูู ุงูุฑุจุญ = ุงูุฅูุฑุงุฏุงุช - ุงูุชูููุฉ
const vendorProfit = vendorEarnings - totalProductionCost;
```

#### ุฌ. ุชุญุฏูุซ ุฑุฃุณ ุงููุงู
```typescript
await prisma.vendor.update({
  where: { id: vendorId },
  data: {
    capitalBalance: {
      increment: vendorProfit  // ุฅุถุงูุฉ ุงูุฑุจุญ ููุท
    },
    totalSales: {
      increment: subtotal      // ุฅุฌูุงูู ุงููุจูุนุงุช
    }
  }
});
```

#### ุฏ. ุณุฌู ุงููุนุงููุฉ
```typescript
await prisma.capitalTransaction.create({
  data: {
    vendorId: vendorId,
    amount: vendorProfit,
    type: "SALE_PROFIT",       // ุฑุจุญ ูู ุจูุน
    description: `ุฑุจุญ ูู ุทูุจ #${orderId}`,
    balanceAfter: vendor.capitalBalance + vendorProfit
  }
});
```

---

### 6๏ธโฃ REJECTED (ูุฑููุถ) โ
**ูุงุฐุง ูุญุฏุซ:**
- ุงูุนููู ุฑูุถ ุงูุงุณุชูุงู
- **ูุชู ุฅุฑุฌุงุน ุงููุฎุฒูู**
- **ูุง ุชูุฌุฏ ุนูููุงุช ูุงููุฉ**
- ุฏูุน ุฑุณูู ุงูุชูุตูู ููุท

```typescript
// ุฅุฑุฌุงุน ุงููุฎุฒูู
await prisma.product.updateMany({
  where: { id: { in: productIds } },
  data: {
    stock: { increment: returnedQuantity }
  }
});
```

---

### 7๏ธโฃ CANCELLED (ููุบู)
**ูุงุฐุง ูุญุฏุซ:**
- ุงูุทูุจ ุฃูุบู ูุจู ุงูุชูุตูู
- **ุฅุฑุฌุงุน ุงููุฎุฒูู ุฅุฐุง ูุงู ูุญุฌูุฒูุง**
- **ูุง ุชูุฌุฏ ุนูููุงุช ูุงููุฉ**

---

## ๐ฐ ุงูุญุณุงุจุงุช ุงููุงููุฉ ุงูุชูุตูููุฉ

### ูุซุงู ุนููู ูุงูู

#### ุงูุทูุจ:
```
3 ููุชุฌุงุช ูู ุชูุดูุฑุช (150 ุฌ.ู ูููุงุญุฏ)
2 ููุชุฌุงุช ูู ุจูุทููู (200 ุฌ.ู ูููุงุญุฏ)
ุฑุณูู ุชูุตูู: 30 ุฌ.ู
```

#### ุงูุญุณุงุจุงุช:

1. **ุงููุฌููุน ุงููุฑุนู (Subtotal)**
```
ุชูุดูุฑุช: 3 ร 150 = 450 ุฌ.ู
ุจูุทููู: 2 ร 200 = 400 ุฌ.ู
โโโโโโโโโโโโโโโโโโโโโโโ
ุงููุฌููุน ุงููุฑุนู = 850 ุฌ.ู
```

2. **ุงูุฅุฌูุงูู ุงูููุงุฆู (Final Amount)**
```
ุงููุฌููุน ุงููุฑุนู: 850 ุฌ.ู
ุฑุณูู ุงูุชูุตูู: + 30 ุฌ.ู
โโโโโโโโโโโโโโโโโโโโโโโ
ุงูุฅุฌูุงูู: 880 ุฌ.ู
```

3. **ุนูููุฉ ุงููุชุฌุฑ (5%)**
```
850 ร 0.05 = 42.5 ุฌ.ู
```

4. **ุฅูุฑุงุฏุงุช ุงูุดุฑูู (95%)**
```
850 ร 0.95 = 807.5 ุฌ.ู
```

5. **ุชูููุฉ ุงูุฅูุชุงุฌ**
```
ุชูุดูุฑุช: 3 ร 80 = 240 ุฌ.ู (ุชูููุฉ 80 ูููุงุญุฏ)
ุจูุทููู: 2 ร 120 = 240 ุฌ.ู (ุชูููุฉ 120 ูููุงุญุฏ)
โโโโโโโโโโโโโโโโโโโโโโโ
ุฅุฌูุงูู ุงูุชูููุฉ = 480 ุฌ.ู
```

6. **ุตุงูู ุฑุจุญ ุงูุดุฑูู**
```
ุงูุฅูุฑุงุฏุงุช: 807.5 ุฌ.ู
ุงูุชูููุฉ: - 480 ุฌ.ู
โโโโโโโโโโโโโโโโโโโโโโโ
ุงูุฑุจุญ ุงูุตุงูู = 327.5 ุฌ.ู โ
```

7. **ุชุญุฏูุซ ุฑุฃุณ ุงููุงู**
```
ุฑุฃุณ ุงููุงู ุงูุณุงุจู: 50,000 ุฌ.ู
ุงูุฑุจุญ: + 327.5 ุฌ.ู
โโโโโโโโโโโโโโโโโโโโโโโ
ุฑุฃุณ ุงููุงู ุงูุฌุฏูุฏ = 50,327.5 ุฌ.ู
```

---

## ๐ ูุนุงุฏูุงุช ุงูุญุณุงุจ

### ุงูุนูููุงุช
```typescript
STORE_COMMISSION_RATE = 0.05  // ุซุงุจุช ูุง ูุชุบูุฑ

storeCommission = subtotal ร STORE_COMMISSION_RATE
vendorEarnings = subtotal ร (1 - STORE_COMMISSION_RATE)
// ุฃู
vendorEarnings = subtotal - storeCommission
```

### ุงูุฃุฑุจุงุญ
```typescript
totalProductionCost = ฮฃ(product.productionCost ร quantity)
vendorProfit = vendorEarnings - totalProductionCost
profitMargin = (vendorProfit / vendorEarnings) ร 100
```

### ุฑุฃุณ ุงููุงู
```typescript
// ุนูุฏ ุงูุจูุน
newCapitalBalance = oldCapitalBalance + vendorProfit

// ุนูุฏ ุงูุดุฑุงุก (ูุงุชูุฑุฉ ูุดุชุฑูุงุช)
newCapitalBalance = oldCapitalBalance - invoiceTotal

// ุนูุฏ ุงูุญุฐู (ุฑุฏ ุฑุฃุณ ุงููุงู)
newCapitalBalance = oldCapitalBalance + refundAmount
```

---

## ๐ ุชุชุจุน ุงูุนูููุงุช

### ุณุฌู ุงููุนุงููุงุช (CapitalTransaction)

ูู ุนูููุฉ ุชุคุซุฑ ุนูู ุฑุฃุณ ุงููุงู ูุชู ุชุณุฌูููุง:

```typescript
enum TransactionType {
  PURCHASE      // ุดุฑุงุก ููุชุฌุงุช/ุฃููุดุฉ
  REFUND        // ุฑุฏ ูุจูุบ (ุญุฐู ููุชุฌ)
  SALE_PROFIT   // ุฑุจุญ ูู ุทูุจ
  CONSIGNMENT_PROFIT  // ุฑุจุญ ูู ุฃูุงูุฉ
}
```

**ูุซุงู ุณุฌู:**
```
2024-01-20 10:30 | ุดุฑุงุก ููุชุฌุงุช     | -5,000 ุฌ.ู  | 45,000 ุฌ.ู
2024-01-21 14:15 | ุฑุจุญ ูู ุทูุจ #abc | +327.5 ุฌ.ู  | 45,327.5 ุฌ.ู
2024-01-22 09:00 | ุฑุฏ ููุชุฌ ูุญุฐูู   | +800 ุฌ.ู    | 46,127.5 ุฌ.ู
```

---

## ๐ฏ ุงูููุงุท ุงููููุฉ

### โ ูุฌุจ ูุนุฑูุชูุง:

1. **ุนูููุฉ ุงููุชุฌุฑ 5% ุซุงุจุชุฉ** - ูุง ูููู ุชุบููุฑูุง ุฃุจุฏูุง
2. **ุงูุฑุจุญ ููุญุณุจ ุนูุฏ ุงูุชูุตูู ููุท** - ูููุณ ุนูุฏ ุชุฃููุฏ ุงูุทูุจ
3. **ุงููุฎุฒูู ููุฎุตู ุนูุฏ ุงูุชุฃููุฏ** - ูููุณ ุนูุฏ ุงูุทูุจ
4. **ุฑุฃุณ ุงููุงู = ุงูุฑุจุญ ุงูุตุงูู** - ูููุณ ุงูุฅูุฑุงุฏุงุช
5. **ุงูุชูููุฉ ุงูุฅูุชุงุฌูุฉ ูููุฉ ุฌุฏูุง** - ุชุญุฏุฏ ุตุงูู ุงูุฑุจุญ

### โ๏ธ ุญุงูุงุช ุฎุงุตุฉ:

#### ุงูุฃูุงูุฉ (Consignment)
```typescript
// ุฅุฐุง ูุงู ุงูููุชุฌ ุฃูุงูุฉ
if (product.isConsignment) {
  // ุญุณุงุจ ุงูุชูููุฉ ูู ุงููููุฑุฏ
  supplierCost = product.supplierCost * quantity;
  vendorProfit = vendorEarnings - supplierCost;
  
  // ุฅูุดุงุก ุณุฌู ุฏูุน ูููููุฑุฏ
  await prisma.supplierPayment.create({
    data: {
      supplierId: product.supplierId,
      amount: supplierCost,
      dueDate: calculateDueDate(), // ุญุณุจ ุงูุงุชูุงู
    }
  });
}
```

#### ุงูุชูุณูุท
```typescript
// ุงูุดุฑูู ูุญุตู ุนูู ูุงูู ุงููุจูุบ ููุฑูุง
// ุงููุชุฌุฑ ูุชุญูู ูุณุคูููุฉ ุงูุชูุณูุท
vendorProfit = vendorEarnings - totalCost; // ููุณ ุงูุญุณุงุจ
```

---

## ๐ ูุซุงู ุนูู ููู ูุงูู

### ุงูุตุจุงุญ:
```
ุฑุฃุณ ุงููุงู: 50,000 ุฌ.ู
```

### ุงูุนูููุงุช:
```
09:00 | ูุงุชูุฑุฉ ูุดุชุฑูุงุช      | -8,000 ุฌ.ู  | 42,000 ุฌ.ู
10:30 | ุทูุจ #1 ุชู ุชูุตููู    | +450 ุฌ.ู    | 42,450 ุฌ.ู
14:00 | ุทูุจ #2 ุชู ุชูุตููู    | +327.5 ุฌ.ู  | 42,777.5 ุฌ.ู
16:00 | ุญุฐู ููุชุฌ ูุฏูู        | +1,200 ุฌ.ู  | 43,977.5 ุฌ.ู
18:00 | ุทูุจ #3 ุชู ุชูุตููู    | +580 ุฌ.ู    | 44,557.5 ุฌ.ู
```

### ููุงูุฉ ุงูููู:
```
ุฑุฃุณ ุงููุงู ุงูููุงุฆู: 44,557.5 ุฌ.ู
ุฅุฌูุงูู ุงููุจูุนุงุช: 1,357.5 ุฌ.ู (ุฃุฑุจุงุญ ุตุงููุฉ)
ุนุฏุฏ ุงูุทูุจุงุช: 3 ุทูุจุงุช
```

---

## ๐๏ธ APIs ุฐุงุช ุงูุตูุฉ

### ุฅูุดุงุก ุทูุจ
```
POST /api/orders
- ูุฑุจุท ุงูุทูุจ ุจุงูุดุฑูู ุชููุงุฆููุง
- ุญุงูุฉ: PENDING
- ูุง ูุฎุตู ุงููุฎุฒูู
```

### ุชุฃููุฏ ุทูุจ
```
PATCH /api/vendor/orders/:id/confirm
- ุชุบููุฑ ุงูุญุงูุฉ: CONFIRMED
- ุฎุตู ุงููุฎุฒูู
```

### ุชูุตูู ุทูุจ
```
PATCH /api/vendor/orders/:id/deliver
- ุชุบููุฑ ุงูุญุงูุฉ: DELIVERED
- ุญุณุงุจ ุงูุฃุฑุจุงุญ
- ุชุญุฏูุซ ุฑุฃุณ ุงููุงู
- ุฅูุดุงุก CapitalTransaction
```

### ุฅูุบุงุก/ุฑูุถ ุทูุจ
```
PATCH /api/vendor/orders/:id/reject
- ุฅุฑุฌุงุน ุงููุฎุฒูู
- ุชุบููุฑ ุงูุญุงูุฉ
```

---

## ๐ก ูุตุงุฆุญ ููุดุฑูู

1. **ุฑุงูุจ ุชูููุฉ ุงูุฅูุชุงุฌ** - ูููุง ูููุช ุงูุชูููุฉุ ุฒุงุฏ ุงูุฑุจุญ
2. **ุงูุฃุฑุจุงุญ ุชุฃุชู ูู ุงูุชูุตูู ุงููุงุฌุญ** - ููุณ ูู ุชุฃููุฏ ุงูุทูุจุงุช
3. **ุฑุฃุณ ุงููุงู = ุงูููุฉ ุงูุดุฑุงุฆูุฉ** - ุงุญุชูุธ ุจุฑุตูุฏ ุฌูุฏ ูููุดุชุฑูุงุช
4. **5% ูููุชุฌุฑ ุฏุงุฆููุง** - ุฎุทุท ุฃุณุนุงุฑู ุนูู ุฃุณุงุณ 95% ุตุงูู
5. **ุณุฌู ุงููุนุงููุงุช ุตุฏููู** - ุฑุงุฌุนู ุจุงุณุชูุฑุงุฑ

---

## ๐ ุฏุนู ููู

ุฅุฐุง ูุงูุช ุงูุญุณุงุจุงุช ุบูุฑ ุตุญูุญุฉ:
1. ุชุญูู ูู `productionCost` ููููุชุฌุงุช
2. ุชุฃูุฏ ูู `STORE_COMMISSION_RATE = 0.05`
3. ุฑุงุฌุน ุณุฌู `CapitalTransaction`
4. ุชุฃูุฏ ูู ุญุงูุฉ ุงูุทูุจ `DELIVERED`

---

**ุขุฎุฑ ุชุญุฏูุซ:** ููุงูุฑ 2024
**ุงูุฅุตุฏุงุฑ:** v1.0
