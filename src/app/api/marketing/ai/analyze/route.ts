import { NextRequest, NextResponse } from "next/server";
import { auth } from "@/lib/auth";

// AI Analysis using OpenAI or similar service
export async function POST(req: NextRequest) {
  try {
    const session = await auth();

    if (!session || session.user?.role !== "ADMIN") {
      return NextResponse.json({ error: "ุบูุฑ ูุตุฑุญ" }, { status: 401 });
    }

    const { type, campaigns, keywords, analytics } = await req.json();

    let analysis = "";

    switch (type) {
      case "campaign_analysis":
        analysis = analyzeCampaignPerformance(campaigns);
        break;
      case "seo_suggestions":
        analysis = generateSEOSuggestions(keywords);
        break;
      case "campaign_optimization":
        analysis = optimizeCampaigns(campaigns);
        break;
      case "campaign_ideas":
        analysis = generateCampaignIdeas(campaigns, analytics);
        break;
      case "ad_copy_improvement":
        analysis = improveAdCopy(campaigns);
        break;
      case "competitor_analysis":
        analysis = analyzeCompetitors(campaigns, keywords);
        break;
      default:
        analysis = "ููุน ุงูุชุญููู ุบูุฑ ูุนุฑูู";
    }

    return NextResponse.json({ analysis });
  } catch (error) {
    console.error("AI Analysis Error:", error);
    return NextResponse.json({ error: "ูุดู ุงูุชุญููู" }, { status: 500 });
  }
}

function analyzeCampaignPerformance(campaigns: any[]) {
  if (campaigns.length === 0) {
    return "๐ **ุชุญููู ุงูุญููุงุช**\n\nูุง ุชูุฌุฏ ุญููุงุช ุญุงููุงู. ููุตุญ ุจุฅูุดุงุก ุญููุฉ ุชุณููููุฉ ุฃููู ููุจุฏุก ูู ุฌุฐุจ ุงูุนููุงุก.";
  }

  const activeCampaigns = campaigns.filter(c => c.status === "ACTIVE");
  const avgROI = campaigns.reduce((sum, c) => sum + c.roi, 0) / campaigns.length;
  const avgCTR = campaigns.reduce((sum, c) => sum + c.ctr, 0) / campaigns.length;
  const totalSpent = campaigns.reduce((sum, c) => sum + c.spent, 0);
  const totalConversions = campaigns.reduce((sum, c) => sum + c.conversions, 0);

  const bestCampaign = campaigns.reduce((best, c) => c.roi > best.roi ? c : best, campaigns[0]);
  const worstCampaign = campaigns.reduce((worst, c) => c.roi < worst.roi ? c : worst, campaigns[0]);

  return `๐ **ุชุญููู ุดุงูู ูุฃุฏุงุก ุงูุญููุงุช**

โ **ุงูููุฎุต ุงูุนุงู:**
- ุฅุฌูุงูู ุงูุญููุงุช: ${campaigns.length}
- ุงูุญููุงุช ุงููุดุทุฉ: ${activeCampaigns.length}
- ุฅุฌูุงูู ุงูุฅููุงู: ${totalSpent.toFixed(0)} ุฌ
- ุฅุฌูุงูู ุงูุชุญูููุงุช: ${totalConversions}

๐ **ูุชูุณุท ุงูุฃุฏุงุก:**
- ูุชูุณุท ROI: ${avgROI.toFixed(0)}%
- ูุชูุณุท CTR: ${avgCTR.toFixed(2)}%
- ุชูููุฉ ุงูุชุญููู: ${totalSpent > 0 && totalConversions > 0 ? (totalSpent / totalConversions).toFixed(0) : 0} ุฌ

๐ **ุฃูุถู ุญููุฉ:**
- ุงูุงุณู: ${bestCampaign.name}
- ROI: ${bestCampaign.roi.toFixed(0)}%
- ุงูุชุญูููุงุช: ${bestCampaign.conversions}
- ุงูููุตุฉ: ${bestCampaign.platform}

โ๏ธ **ุฃุณูุฃ ุญููุฉ (ุชุญุชุงุฌ ุชุญุณูู):**
- ุงูุงุณู: ${worstCampaign.name}
- ROI: ${worstCampaign.roi.toFixed(0)}%
- CTR: ${worstCampaign.ctr.toFixed(2)}%

๐ก **ุงูุชูุตูุงุช:**
${avgROI < 100 ? "- โ๏ธ ูุชูุณุท ROI ุฃูู ูู 100%ุ ุฑุงุฌุน ุงุณุชูุฏุงู ุงูุฌูููุฑ ูุงููููุงุช ุงูููุชุงุญูุฉ\n" : ""}
${avgCTR < 2 ? "- โ๏ธ ูุนุฏู ุงูููุฑ ููุฎูุถุ ุญุณูู ูุตูุต ุงูุฅุนูุงูุงุช ูุงูุนูุงููู\n" : ""}
- โ ุงุณุชุซูุฑ ุฃูุซุฑ ูู ุงูุญููุฉ "${bestCampaign.name}" ูุฃููุง ุชุญูู ุฃูุถู ุงููุชุงุฆุฌ
- ๐ ุฃุนุฏ ุชูููู ุงูุญููุฉ "${worstCampaign.name}" ุฃู ุฃููููุง ูุคูุชุงู
- ๐ฑ ุฌุฑูุจ ููุตุงุช ุฌุฏูุฏุฉ ุฅุฐุง ูุงูุช ูุนุธู ุญููุงุชู ุนูู ููุตุฉ ูุงุญุฏุฉ`;
}

function generateSEOSuggestions(keywords: any[]) {
  if (keywords.length === 0) {
    return "๐ **ุงูุชุฑุงุญุงุช SEO**\n\nูู ูุชู ุฅุถุงูุฉ ูููุงุช ููุชุงุญูุฉ ุจุนุฏ. ุงุจุฏุฃ ุจุฅุถุงูุฉ ุงููููุงุช ุงูุฃุณุงุณูุฉ ุงููุชุนููุฉ ุจููุชุฌุงุชู.";
  }

  const avgDifficulty = keywords.reduce((sum, k) => sum + (k.difficulty || 0), 0) / keywords.length;
  const easyKeywords = keywords.filter(k => k.difficulty && k.difficulty < 40);
  const hardKeywords = keywords.filter(k => k.difficulty && k.difficulty > 70);

  return `๐ **ุงูุชุฑุงุญุงุช ุชุญุณูู ูุญุฑูุงุช ุงูุจุญุซ (SEO)**

๐ **ุชุญููู ุงููููุงุช ุงูููุชุงุญูุฉ:**
- ุฅุฌูุงูู ุงููููุงุช: ${keywords.length}
- ูุชูุณุท ุงูุตุนูุจุฉ: ${avgDifficulty.toFixed(0)}/100
- ูููุงุช ุณููุฉ: ${easyKeywords.length}
- ูููุงุช ุตุนุจุฉ: ${hardKeywords.length}

โ **ุงููููุงุช ุงูุณููุฉ (ุงุจุฏุฃ ุจูุง):**
${easyKeywords.slice(0, 3).map(k => `- "${k.keyword}" (ุตุนูุจุฉ: ${k.difficulty}, ุญุฌู ุงูุจุญุซ: ${k.searchVolume || "ุบูุฑ ูุนุฑูู"})`).join('\n') || "ูุง ุชูุฌุฏ"}

โ๏ธ **ุงููููุงุช ุงูุตุนุจุฉ (ุชุญุชุงุฌ ุงุณุชุฑุงุชูุฌูุฉ ุทูููุฉ ุงููุฏู):**
${hardKeywords.slice(0, 3).map(k => `- "${k.keyword}" (ุตุนูุจุฉ: ${k.difficulty})`).join('\n') || "ูุง ุชูุฌุฏ"}

๐ก **ุงูุชูุตูุงุช:**
1. ๐ฏ **ุงุณุชูุฏู Long-Tail Keywords**: ูููุงุช ุทูููุฉ ูุญุฏุฏุฉ ูุซู "ูุณุงุชูู ุณูุฑุฉ ุฑุฎูุตุฉ ุจุงููุงูุฑุฉ"
2. ๐ **ุงููุญุชูู ุงูุฌูุฏ**: ุฃูุดุฆ ุตูุญุงุช ุฌูุฏุฉ ุนุงููุฉ ููู ูููุฉ ููุชุงุญูุฉ
3. ๐ **ุงูุฑูุงุจุท ุงูุฏุงุฎููุฉ**: ุงุฑุจุท ุตูุญุงุช ูููุนู ุจุจุนุถูุง
4. ๐ฑ **ุงูุณุฑุนุฉ ูุงูููุจุงูู**: ุชุฃูุฏ ูู ุณุฑุนุฉ ุงููููุน ูุชูุงููู ูุน ุงูุฌูุงู
5. ๐ผ๏ธ **ุงูุตูุฑ**: ุงุณุชุฎุฏู ุตูุฑ ุนุงููุฉ ุงูุฌูุฏุฉ ูุน ูุตูุต ุจุฏููุฉ (Alt Text)
6. ๐ **SEO ุงููุญูู**: ุฃุถู ูููุนู ุนูู Google My Business
7. โญ **ุงููุฑุงุฌุนุงุช**: ุงุทูุจ ูู ุนููุงุฆู ูุชุงุจุฉ ูุฑุงุฌุนุงุช
8. ๐ **ุงูุชุญูููุงุช**: ุฑุงูุจ ุชุฑุชูุจู ุฃุณุจูุนูุงู ูุนุฏูู ุงูุงุณุชุฑุงุชูุฌูุฉ`;
}

function optimizeCampaigns(campaigns: any[]) {
  const lowPerformingCampaigns = campaigns.filter(c => c.roi < 100 && c.status === "ACTIVE");
  const overBudgetCampaigns = campaigns.filter(c => c.spent > c.budget);

  return `๐ **ุฎุทุฉ ุชุญุณูู ุงูุญููุงุช**

${lowPerformingCampaigns.length > 0 ? `
โ๏ธ **ุญููุงุช ุชุญุชุงุฌ ุชุญุณูู ููุฑู:**
${lowPerformingCampaigns.map(c => `
๐ **${c.name}**
- ROI ุงูุญุงูู: ${c.roi.toFixed(0)}% (ุงููุฏู: 150%+)
- CTR: ${c.ctr.toFixed(2)}% ${c.ctr < 2 ? "(ููุฎูุถ)" : ""}
- ุงูุชุญูููุงุช: ${c.conversions}

๐ง **ุฎุทูุงุช ุงูุชุญุณูู:**
1. ุฃุนุฏ ุตูุงุบุฉ ุงูุนููุงู ููููู ุฃูุซุฑ ุฌุงุฐุจูุฉ
2. ุงุณุชูุฏู ุฌูููุฑ ุฃุถูู ูุฃูุซุฑ ุชุญุฏูุฏุงู
3. ุฌุฑูุจ ุตูุฑ/ููุฏูููุงุช ูุฎุชููุฉ
4. ููู ุงูุณุนุฑ ุฃู ุฃุถู ุนุฑุถ ุฎุงุต
5. ุฃุถู call-to-action ูุงุถุญ (ุงุดุชุฑู ุงูุขูุ ุงุญุตู ุนูู ุฎุตู)
`).join('\n')}
` : ""}

${overBudgetCampaigns.length > 0 ? `
๐ฐ **ุญููุงุช ุชุฌุงูุฒุช ุงูููุฒุงููุฉ:**
${overBudgetCampaigns.map(c => `- ${c.name}: ${c.spent.toFixed(0)} / ${c.budget.toFixed(0)} ุฌ`).join('\n')}
` : ""}

โ **ูุตุงุฆุญ ุนุงูุฉ ููุชุญุณูู:**
1. **A/B Testing**: ุงุฎุชุจุฑ ูุณุฎุชูู ูู ูู ุฅุนูุงู
2. **ุงูุชูููุช**: ุงูุดุฑ ุงูุฅุนูุงูุงุช ูู ุงูุฃููุงุช ุงูุฃูุซุฑ ูุดุงุทุงู
3. **ุงูุฌูููุฑ**: ุงุณุชูุฏู ูู ุชูุงุนู ูุน ุฅุนูุงูุงุชู ุณุงุจูุงู (Retargeting)
4. **ุงูุตูุญุฉ ุงูููุตูุฏุฉ**: ุชุฃูุฏ ุฃู ุตูุญุฉ ุงููุจูุท ุณุฑูุนุฉ ููุงุถุญุฉ
5. **ุงูุนุฑูุถ**: ุฃุถู "ุฎุตู ููุชุฑุฉ ูุญุฏูุฏุฉ" ูุฒูุงุฏุฉ ุงูุงุณุชุนุฌุงู
6. **ุงููููุงุช ุงูุณูุจูุฉ**: ุฃุถู ูููุงุช ุณูุจูุฉ ูููุน ุงูููุฑุงุช ุบูุฑ ุงููููุฏุฉ
7. **ุงููุฑุงูุจุฉ**: ุชุงุจุน ุงูุญููุงุช ููููุงู ูุนุฏูู ุงูููุฒุงููุฉ ุญุณุจ ุงูุฃุฏุงุก`;
}

function generateCampaignIdeas(campaigns: any[], analytics: any[]) {
  return `๐ก **ุฃููุงุฑ ุญููุงุช ุชุณููููุฉ ุฌุฏูุฏุฉ**

๐ฏ **ุญููุงุช ููุณููุฉ:**
1. ๐ **ุฑูุถุงู/ุงูุนูุฏ**: "ุนุฑูุถ ุฑูุถุงู - ุฎุตู 30% ุนูู ุฌููุน ุงูููุงุจุณ"
2. ๐ **ุนูุฏ ุงูุญุจ**: "ูุฏุงูุง ุนูุฏ ุงูุญุจ ุงููุซุงููุฉ"
3. ๐ **ุงูุนูุฏุฉ ูููุฏุฑุณุฉ**: "ุชุฌููุฒุงุช ุงููุฏุฑุณุฉ ุจุฃุณุนุงุฑ ูุง ุชูุงูู"
4. ๐ **ููุงูุฉ ุงูุนุงู**: "ุชุฎููุถุงุช ููุงูุฉ ุงูููุณู - ุญุชู 50%"

๐ฑ **ุญููุงุช ุฑูููุฉ:**
1. ๐ธ **Instagram Stories**: ุฅุนูุงูุงุช ูุตูุฑุฉ ูุฌุฐุงุจุฉ
2. ๐ฅ **ููุฏูููุงุช ูุตูุฑุฉ**: Reels & TikTok ุชุนุฑุถ ุงูููุชุฌุงุช
3. ๐ **Influencer Marketing**: ุชุนุงูู ูุน ูุคุซุฑูู ูู ูุฌุงู ุงูุฃุฒูุงุก
4. ๐ฌ **User Generated Content**: ุดุฌุน ุงูุนููุงุก ุนูู ูุดุงุฑูุฉ ุตูุฑูู

๐ **ุญููุงุช ุชุฑููุฌูุฉ:**
1. **ุงุดุชุฑู 2 ูุงุญุตู ุนูู ุงูุซุงูุซ ูุฌุงูุงู**
2. **ุฎุตู ููุนููุงุก ุงูุฌุฏุฏ**: -20% ุนูู ุฃูู ุทูุจ
3. **ุจุฑูุงูุฌ ุงูููุงุก**: ููุงุท ูุน ูู ุนูููุฉ ุดุฑุงุก
4. **ุงูุดุญู ุงููุฌุงูู**: ูุทูุจุงุช ุฃูุซุฑ ูู 500 ุฌ

๐ **Retargeting:**
1. ุงุณุชูุฏู ูู ุฃุถุงู ููุชุฌ ููุณูุฉ ููู ูููู ุงูุดุฑุงุก
2. ุงุณุชูุฏู ูู ุฒุงุฑ ุงููููุน ููู ูุดุชุฑู
3. ุงุณุชูุฏู ุนููุงุก ุณุงุจููู ุจููุชุฌุงุช ุฌุฏูุฏุฉ

๐ **ุงุณุชูุงุฏุงู ูุจูุงูุงุชู:**
- ุฃูุดุฆ ุญููุงุช ููููุชุฌุงุช ุงูุฃูุซุฑ ูุจูุนุงู
- ุงุณุชูุฏู ุงููุฏู/ุงูููุงุทู ุงูุชู ุชุญูู ุฃุนูู ูุจูุนุงุช
- ุฌุฑูุจ ููุตุงุช ุฅุนูุงููุฉ ุฌุฏูุฏุฉ (Snapchat, LinkedIn)`;
}

function improveAdCopy(campaigns: any[]) {
  return `โ๏ธ **ุชุญุณูู ูุตูุต ุงูุฅุนูุงูุงุช**

๐ฏ **ุงูููููุงุช ุงูุฃุณุงุณูุฉ ูุฅุนูุงู ูุงุฌุญ:**

1๏ธโฃ **ุนููุงู ููู (Headline):**
โ ุณูุก: "ููุงุจุณ ููุจูุน"
โ ุฌูุฏ: "ุฃุญุฏุซ ุตูุญุงุช ุงูููุถุฉ 2026 - ุฎุตู 40% ููุชุฑุฉ ูุญุฏูุฏุฉ!"

2๏ธโฃ **ูุตู ุฌุฐุงุจ:**
โ ุณูุก: "ุนูุฏูุง ููุงุจุณ ูุซูุฑุฉ"
โ ุฌูุฏ: "ุชุฃูู ุจุฅุทูุงูุฉ ุนุตุฑูุฉ! ๐ ูุฆุงุช ุงูุชุตุงููู ุงูุญุตุฑูุฉ ุจุฃุณุนุงุฑ ูุง ุชููุงูู"

3๏ธโฃ **Call to Action ูุงุถุญ:**
โ ุณูุก: "ุชุตูุญ ุงููููุน"
โ ุฌูุฏ: "ุงุดุชุฑู ุงูุขู ูุงุญุตู ุนูู ุดุญู ูุฌุงูู!"

๐ **ุตูุบ ูุฌุฑุจุฉ ุชุนูู:**
- "ุงุญุตู ุนูู [ูุงุฆุฏุฉ] ุจุฏูู [ุนุงุฆู]" โ "ุงุญุตู ุนูู ูุณุชุงู ุฃุญูุงูู ุจุฏูู ุชูุงููู ุดุญู"
- "ุงูุณุฑ ุงูุฐู ูุง ูุฎุจุฑู ุจู [ููุงูุณ]" โ "ุงูุณุฑ ุงูุฐู ูุง ุชุฎุจุฑู ุจู ุงูุนูุงูุงุช ุงููุจูุฑุฉ"
- "[ุฑูู] ุทุฑู ูู [ูุชูุฌุฉ]" โ "5 ุทุฑู ูุชุจุฏู ุฃูููุงู ุจููุฒุงููุฉ ูุญุฏูุฏุฉ"

๐ฅ **ูููุงุช ูููุฉ ุชุฒูุฏ ุงูุชูุงุนู:**
- โก ููุฑุงูุ ุงูุขูุ ููุชุฑุฉ ูุญุฏูุฏุฉ
- ๐ ูุฌุงููุ ูุฏูุฉุ ุจููุต
- ๐ฐ ุฎุตูุ ุชูููุฑุ ุนุฑุถ ุฎุงุต
- โจ ุญุตุฑูุ ูุงุฎุฑุ ูููุฒ
- โ ูุถูููุ ุขููุ ููุซูู

๐ฑ **ูุตุงุฆุญ ููููุตุงุช:**

**Google Ads:**
- ุงุณุชุฎุฏู ูููุงุช ุงูุฌูููุฑ ุงููุณุชูุฏู ูู ุงูุนููุงู
- ุฃุถู ุฃุฑูุงู ููุณุจ ูุญุฏุฏุฉ
- ุงุฐูุฑ ุงููููุฒุงุช ุงููุฑูุฏุฉ

**Facebook/Instagram:**
- ุงุจุฏุฃ ุจุณุคุงู ูุซูุฑ ุงููุถูู
- ุงุณุชุฎุฏู ุงูุฅูููุฌู ุจุฐูุงุก
- ุฃุถู ูุตุฉ ุฃู ุนุงุทูุฉ

**TikTok/Snapchat:**
- ูู ูุฑุญ ูุบูุฑ ุฑุณูู
- ุงุณุชุฎุฏู ูุบุฉ ุงูุดุจุงุจ
- ุฑูุฒ ุนูู ุงููููุนุฉ ุงูุณุฑูุนุฉ`;
}

function analyzeCompetitors(campaigns: any[], keywords: any[]) {
  return `๐ **ุชุญููู ุงูููุงูุณูู ูุงุณุชุฑุงุชูุฌูุงุช ุงูุชููู**

๐ฏ **ููู ุชุชููู ุนูู ููุงูุณูู:**

1๏ธโฃ **ุงูุชุณุนูุฑ ุงูุฐูู:**
- ูุง ุชูุงูุณ ููุท ุจุงูุณุนุฑ ุงูุฃูู
- ูุฏูู ูููุฉ ุฃูุจุฑ (ุดุญู ูุฌุงููุ ุถูุงูุ ุฅุฑุฌุงุน ุณูู)
- ุนุฑูุถ Bundle: ุงุดุชุฑู 3 ุจุณุนุฑ 2

2๏ธโฃ **ุงูุชููุฒ ูู ุงูููุชุฌ:**
- โจ ุชุตุงููู ุญุตุฑูุฉ ุบูุฑ ูุชููุฑุฉ ุนูุฏ ุงูููุงูุณูู
- ๐ท๏ธ ุฌูุฏุฉ ุฃูุถู ุจููุณ ุงูุณุนุฑ
- ๐ฆ ุชุบููู ุฑุงูู ููููุฒ
- โก ุชูุตูู ุฃุณุฑุน

3๏ธโฃ **ุชุฌุฑุจุฉ ุนููุงุก ุฃูุถู:**
- ๐ฌ ุฑุฏ ุณุฑูุน ุนูู ุงูุงุณุชูุณุงุฑุงุช
- ๐ฑ ูููุน ุณูู ุงูุงุณุชุฎุฏุงู
- ๐ ููุงูุขุช ุงูููุงุก
- โญ ุฎุฏูุฉ ูุง ุจุนุฏ ุงูุจูุน ููุชุงุฒุฉ

4๏ธโฃ **ุงูุชุณููู ุงูุฐูู:**
- ๐ธ ุตูุฑ ููุชุฌุงุช ุฃูุถู ูุงุญุชุฑุงููุฉ
- ๐ฅ ููุฏูููุงุช ุชูุถุญ ุงูููุชุฌ
- ๐ ูุญุชูู ุชุนูููู (ูุตุงุฆุญ ุฃุฒูุงุก)
- ๐ ุชุนุงูู ูุน ูุคุซุฑูู ุตุบุงุฑ (Micro-influencers)

5๏ธโฃ **ููุงุท ุถุนู ุงูููุงูุณูู:**
ุฑุงูุจ:
- ุดูุงูู ุงูุนููุงุก ูู ุงููุฑุงุฌุนุงุช
- ุงูููุชุฌุงุช ุบูุฑ ุงููุชููุฑุฉ ุนูุฏูู
- ุงูููุงุทู ุงูุชู ูุง ููุตููู ููุง
- ุฃููุงุช ุงูุฑุฏ ุงูุจุทูุฆุฉ

ุซู ูุฏูู ุงูุญู!

๐ **ุงุณุชุฑุงุชูุฌูุฉ ุงูุจูุงูุงุช:**
- ุฑุงูุจ ูููุงุชูู ุงูููุชุงุญูุฉ ูุงุณุชูุฏู ุฃูุถู ูููุง
- ุชุชุจุน ุฅุนูุงูุงุชูู ุจุงุณุชุฎุฏุงู Facebook Ad Library
- ุญูู ุฃุณุนุงุฑูู ุฃุณุจูุนูุงู
- ูุงุญุธ ุชูุงุนู ุฌูููุฑูู ุนูู ุงูุณูุดูุงู ููุฏูุง

๐ก **ุงูููุฒุฉ ุงูุชูุงูุณูุฉ ุงูุญููููุฉ:**
ูุง ุชููุฏ ุงูููุงูุณูู... ุจู ูู ูุฎุชููุงู!
- ุงุฎุชุฑ niche ูุญุฏุฏ (ููุงุจุณ ูุญุฌุจุงุชุ ุฃุฒูุงุก ุฑูุงุถูุฉุ ุฅูุฎ)
- ุงุจูู ุนูุงูุฉ ุชุฌุงุฑูุฉ ููุง ูุตุฉ ููููุฉ
- ุฑูุฒ ุนูู ูุฆุฉ ุนููุงุก ูุญุฏุฏุฉ
- ูุฏู ุชุฌุฑุจุฉ ูุง ุชููุณู`;
}
