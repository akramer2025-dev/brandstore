import { NextRequest, NextResponse } from "next/server";
import { auth } from "@/lib/auth";

export async function POST(request: NextRequest) {
  try {
    const session = await auth();

    if (!session || session.user?.role !== "ADMIN") {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const { action, data, analytics, orders } = await request.json();

    let optimization = "";

    switch (action) {
      case "optimize_campaign":
        // Calculate current performance metrics
        const totalRevenue = orders?.reduce((sum: number, order: any) => sum + order.totalAmount, 0) || 0;
        const totalVisitors = analytics?.reduce((sum: number, a: any) => sum + a.visitors, 0) || 1;
        const conversionRate = (orders?.length || 0) / totalVisitors * 100;
        const avgOrderValue = orders?.length > 0 ? totalRevenue / orders.length : 0;
        const currentCPA = parseFloat(data.targetBudget) / (orders?.length || 1);

        optimization = `# ๐ฏ ุชุญููู ูุชุญุณูู Media Buyer ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู

## ๐ ุชุญููู ุงูุฃุฏุงุก ุงูุญุงูู
- ูุนุฏู ุงูุชุญููู: ${conversionRate.toFixed(2)}%
- ูุชูุณุท ูููุฉ ุงูุทูุจ: ${avgOrderValue.toLocaleString('ar-EG')} ุฌููู
- ุชูููุฉ ุงูุชุณุงุจ ุงูุนููู CPA: ${currentCPA.toLocaleString('ar-EG')} ุฌููู
- ุงูููุฒุงููุฉ ุงููุณุชูุฏูุฉ: ${parseFloat(data.targetBudget || 0).toLocaleString('ar-EG')} ุฌููู

## ๐ฏ ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุญุณูู ุงูููุชุฑุญุฉ

### 1. ุชุญุณูู ุงูุงุณุชูุฏุงู
${data.campaignObjective === 'conversions' ? `
**ููุชุญูููุงุช:**
- ุงุณุชูุฏุงู ุฌูููุฑ ูุดุงุจู (Lookalike) ุจูุณุจุฉ 1-2%
- ุฅุนุงุฏุฉ ุงุณุชูุฏุงู ุฒูุงุฑ ุงููููุน ุขุฎุฑ 7 ุฃูุงู
- ุงุณุชูุฏุงู ุงูุงูุชูุงูุงุช ุฐุงุช ุงูุตูุฉ ุจุงูููุชุฌ
` : data.campaignObjective === 'traffic' ? `
**ูุฒูุงุฑุงุช ุงููููุน:**
- ุงุณุชูุฏุงู ูุงุณุน ูุน ุงูุชูุงูุงุช ุนุงูุฉ
- ุงุณุชูุฏุงู ุงูููุงุทู ุงูุฌุบุฑุงููุฉ ุงูุฃูุซุฑ ูุดุงุทุงู
- ุชุฑููุฒ ุนูู ุงูุฃุนูุงุฑ 25-45 ุณูุฉ
` : `
**ุงุณุชูุฏุงู ุนุงู:**
- ุชุญููู ุงูุจูุงูุงุช ุงูุฏูููุบุฑุงููุฉ ููุนููุงุก ุงูุญุงูููู
- ุชุฌุฑุจุฉ ุงุณุชูุฏุงูุงุช ูุชููุนุฉ A/B Testing
- ุงูุชุฑููุฒ ุนูู ุงูุฌูููุฑ ุงูุฃูุซุฑ ุชูุงุนูุงู
`}

### 2. ุชูุฒูุน ุงูููุฒุงููุฉ ุงูุฃูุซู
- **ุงูุญููุงุช ุงูุจุงุฑุฏุฉ (Cold):** 60% ูู ุงูููุฒุงููุฉ
- **ุฅุนุงุฏุฉ ุงูุงุณุชูุฏุงู (Retargeting):** 30% ูู ุงูููุฒุงููุฉ  
- **ุงูุฌูููุฑ ุงููุดุงุจู (Lookalike):** 10% ูู ุงูููุฒุงููุฉ

**ุงูููุฒุงููุฉ ุงูููููุฉ ุงูููุชุฑุญุฉ:** ${(parseFloat(data.targetBudget || 0) / 30).toLocaleString('ar-EG')} ุฌููู/ููู

### 3. ุฅุนุฏุงุฏุงุช ุงูุญููุฉ ุงููุซูู
- **ุงุณุชุฑุงุชูุฌูุฉ ุงูุนุฑูุถ:** Cost Cap ุจู ${(currentCPA * 0.8).toFixed(0)} ุฌููู
- **ุงูุชุญุณูู:** ${data.campaignObjective === 'conversions' ? 'Conversions' : data.campaignObjective === 'traffic' ? 'Landing Page Views' : 'Link Clicks'}
- **ูุฏุฉ ุงูุชุนูู:** ุงุชุฑู ุงูุญููุฉ ุชุชุนูู 7 ุฃูุงู ูุจู ุงูุชุนุฏูู

### 4. ุงุฎุชุจุงุฑุงุช A/B ููุชุฑุญุฉ
1. **ุงูุตูุฑ:** ุงุฎุชุจุฑ 3-4 ุตูุฑ ูุฎุชููุฉ
2. **ุงููุตูุต:** ุงุฎุชุจุฑ ูุจุฑุงุช ูุฎุชููุฉ (ุนุงุทููุฉ vs ุนููุงููุฉ)
3. **Call-to-Action:** ุงุฎุชุจุฑ ุฃุฒุฑุงุฑ ูุฎุชููุฉ
4. **ุงูุฌูููุฑ:** ุงุฎุชุจุฑ ุดุฑุงุฆุญ ุนูุฑูุฉ ูุฎุชููุฉ

### 5. ูุคุดุฑุงุช KPIs ูููุชุงุจุนุฉ
- **CPM:** ูุฌุจ ุฃู ูููู ุฃูู ูู 15 ุฌููู
- **CTR:** ูุฌุจ ุฃู ูููู ุฃุนูู ูู 1%
- **CPC:** ูุฌุจ ุฃู ูููู ุฃูู ูู 2 ุฌููู
- **CPA:** ุงููุฏู ${(currentCPA * 0.7).toFixed(0)} ุฌููู
- **ROAS:** ุงููุฏู 4:1 (4 ุฌููู ุนุงุฆุฏ ููู ุฌููู ููููู)

### 6. ุชุญุณููุงุช ููููุฉ
- โ ุฑุงุฌุน ุงูุฃุฏุงุก ููููุงู ูู ุงูุตุจุงุญ
- โ ุฃููู ุงูุฅุนูุงูุงุช ุฐุงุช CPA ุฃุนูู ูู ${(currentCPA * 1.2).toFixed(0)} ุฌููู
- โ ุฒูุฏ ุงูููุฒุงููุฉ ููุฅุนูุงูุงุช ุงููุงุฌุญุฉ ุจู 20%
- โ ุงุฎุชุจุฑ ูุตูุต ุฌุฏูุฏุฉ ูู 3 ุฃูุงู

### 7. ุชููุนุงุช ุงููุชุงุฆุฌ (ุจุนุฏ ุงูุชุญุณูู)
- **ุฒูุงุฏุฉ ูุนุฏู ุงูุชุญููู:** +35-50%
- **ุชูููู CPA:** -25-40%
- **ุชุญุณูู ROAS:** +40-60%
- **ุฒูุงุฏุฉ ุงูุนุงุฆุฏ ุงูุฅุฌูุงูู:** +50-70%

## โก ุฎุทุฉ ุงูุนูู ููุฃุณุจูุน ุงููุงุฏู

**ุงูููู 1-2:** ุฅุนุฏุงุฏ ุงูุญููุงุช ุงูุฌุฏูุฏุฉ
**ุงูููู 3-7:** ูุฑุงูุจุฉ ูุชุญุณูู ูููู
**ุงูููู 8-14:** ุชูุณุน ุงูุญููุงุช ุงููุงุฌุญุฉ

## ๐ก ูุตุงุฆุญ ุฅุถุงููุฉ
- ุงุณุชุฎุฏู Facebook Pixel ูุชุชุจุน ุงูุชุญูููุงุช
- ุงุฑุจุท Google Analytics ูุชุญููู ุฃุนูู
- ุฌููุน ุจูุงูุงุช ุงูุนููุงุก ูุชุญุณูู ุงูุงุณุชูุฏุงู
- ุงุฎุชุจุฑ ุงูุฅุนูุงู ุนูู ุฃููุงุช ูุฎุชููุฉ ูู ุงูููู`;

        break;

      default:
        optimization = "ููุน ุงูุนูููุฉ ุบูุฑ ูุฏุนูู";
    }

    return NextResponse.json({
      optimization,
      success: true
    });

  } catch (error) {
    console.error('Error in media buyer API:', error);
    return NextResponse.json({ error: "Internal server error" }, { status: 500 });
  }
}