import { NextRequest, NextResponse } from "next/server";
import { auth } from "@/lib/auth";

export async function POST(request: NextRequest) {
  try {
    const session = await auth();

    if (!session || session.user?.role !== "ADMIN") {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const { action, data, campaigns, analytics } = await request.json();

    let strategy = "";

    switch (action) {
      case "create_strategy":
        const budget = parseFloat(data.budget || 0);
        const hasCurrentCampaigns = campaigns && campaigns.length > 0;
        const hasAnalytics = analytics && analytics.length > 0;

        strategy = `# ๐ ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูุชุณููููุฉ ุงูุดุงููุฉ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู

## ๐ฏ ุชุญููู ุงููุถุน ุงูุญุงูู
**ููุน ุงููุดุงุท:** ${data.businessType}
**ุงูุฃูุฏุงู:** ${data.goals}
**ุงูููุฒุงููุฉ:** ${budget ? budget.toLocaleString('ar-EG') + ' ุฌููู' : 'ุบูุฑ ูุญุฏุฏุฉ'}
**ุงูุญููุงุช ุงูุญุงููุฉ:** ${hasCurrentCampaigns ? campaigns.length + ' ุญููุฉ ูุดุทุฉ' : 'ูุง ุชูุฌุฏ ุญููุงุช'}

## ๐ ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูููุชุฑุญุฉ

### ุงููุฑุญูุฉ ุงูุฃููู: ุงูุจูุงุก (ุงูุฃุณุงุจูุน 1-4)
**ุงููุฏู:** ูุถุน ุงูุฃุณุงุณุงุช ูุงูุชุนุฑูู ุจุงูุนูุงูุฉ ุงูุชุฌุงุฑูุฉ

#### 1. ุชุทููุฑ ุงููููุฉ ุงูุชุณููููุฉ
- ุฅูุดุงุก ุฑุณุงูุฉ ุนูุงูุฉ ุชุฌุงุฑูุฉ ูุงุถุญุฉ
- ุชุตููู ูุญุชูู ุจุตุฑู ูุชุณู
- ุชุญุฏูุฏ ูุจุฑุฉ ุงูุชูุงุตู ูุน ุงูุฌูููุฑ

#### 2. ุจูุงุก ุงูุญุถูุฑ ุงูุฑููู
${data.businessType.includes('ูุชุฌุฑ') || data.businessType.includes('ููุชุฌ') ? `
**ููุชุฌุงุฑุฉ ุงูุฅููุชุฑูููุฉ:**
- ุชุญุณูู ุตูุญุงุช ุงูููุชุฌุงุช ููู SEO
- ุฅูุดุงุก ูุญุชูู ุชุนูููู ุญูู ุงูููุชุฌุงุช
- ุจูุงุก ูุฑุงุฌุนุงุช ูุชููููุงุช ุงูุนููุงุก
` : data.businessType.includes('ุฎุฏูุฉ') || data.businessType.includes('ุชุนููู') ? `
**ููุฎุฏูุงุช:**
- ุฅูุดุงุก ูุญุชูู ุชุนูููู ูุจุฑุฒ ุงูุฎุจุฑุฉ
- ูุดุฑ ุฏุฑุงุณุงุช ุญุงูุฉ ููุตุต ูุฌุงุญ
- ุจูุงุก ุงูุซูุฉ ูู ุฎูุงู ุงูุดูุงุฏุงุช
` : `
**ุงุณุชุฑุงุชูุฌูุฉ ุนุงูุฉ:**
- ุชุทููุฑ ูุญุชูู ูุญู ูุดุงูู ุงูุฌูููุฑ
- ุจูุงุก ุนูุงูุงุช ูุน ุงูุนููุงุก ุงููุญุชูููู
- ุฅูุดุงุก ุญุถูุฑ ููู ุนูู ูุณุงุฆู ุงูุชูุงุตู
`}

#### 3. ุชูุฒูุน ุงูููุฒุงููุฉ - ุงููุฑุญูุฉ ุงูุฃููู
${budget > 0 ? `
- **ุฅุนูุงูุงุช ุงููุนู:** ${(budget * 0.4).toLocaleString('ar-EG')} ุฌููู (40%)
- **ุฅูุดุงุก ุงููุญุชูู:** ${(budget * 0.3).toLocaleString('ar-EG')} ุฌููู (30%)
- **ุฃุฏูุงุช ูุชุญูููุงุช:** ${(budget * 0.2).toLocaleString('ar-EG')} ุฌููู (20%)
- **ุงุฎุชุจุงุฑุงุช ูุชุฌุงุฑุจ:** ${(budget * 0.1).toLocaleString('ar-EG')} ุฌููู (10%)
` : `
**ุชูุฒูุน ุงูุฌููุฏ (ุจุฏูู ููุฒุงููุฉ):**
- ุงูุชุฑููุฒ ุนูู ุงููุญุชูู ุงูุนุถูู 
- ุงุณุชุฎุฏุงู ูุณุงุฆู ุงูุชูุงุตู ุงููุฌุงููุฉ
- ุจูุงุก ุดุจูุฉ ุนูุงูุงุช
`}

### ุงููุฑุญูุฉ ุงูุซุงููุฉ: ุงูููู (ุงูุฃุณุงุจูุน 5-8)
**ุงููุฏู:** ุฒูุงุฏุฉ ุงููุตูู ูุฌุฐุจ ุนููุงุก ุฌุฏุฏ

#### 1. ุญููุงุช ุงูุงุณุชูุฏุงู ุงููุชูุฏู
- ุฅูุดุงุก ุฌูููุฑ ูุดุงุจู ูู ุงูุนููุงุก ุงูุญุงูููู
- ุงุณุชูุฏุงู ุงููููุงุช ุงูุฑุฆูุณูุฉ ุนุงููุฉ ุงูุชุญููู
- ุชุทููุฑ ุญููุงุช ุฅุนุงุฏุฉ ุงูุงุณุชูุฏุงู

#### 2. ุงุณุชุฑุงุชูุฌูุงุช ุงููุญุชูู ุงููุชูุฏูุฉ
- ูุญุชูู ุชูุงุนูู (ุงุณุชุทูุงุนุงุชุ ูุณุงุจูุงุช)
- ููุฏูููุงุช ูุตูุฑุฉ ูุฌุฐุงุจุฉ
- ูุญุชูู ูู ุฅูุดุงุก ุงููุณุชุฎุฏููู (UGC)

#### 3. ุดุฑุงูุงุช ุงุณุชุฑุงุชูุฌูุฉ
- ุงูุชุนุงูู ูุน ุงููุคุซุฑูู ุงููุญูููู
- ุดุฑุงูุงุช ูุน ุฃุนูุงู ููููุฉ
- ุงููุดุงุฑูุฉ ูู ูุนุงููุงุช ุงููุฌุชูุน

### ุงููุฑุญูุฉ ุงูุซุงูุซุฉ: ุงูุชุญุณูู (ุงูุฃุณุงุจูุน 9-12)
**ุงููุฏู:** ุชุญุณูู ูุนุฏูุงุช ุงูุชุญููู ูุฒูุงุฏุฉ ุงูุฅูุฑุงุฏุงุช

#### 1. ุชุญููู ุงูุจูุงูุงุช ูุงูุชุญุณูู
- ุชุญููู ุฑุญูุฉ ุงูุนููู
- ุชุญุณูู ููุงุท ุงูุชุญููู
- ุงุฎุชุจุงุฑ A/B ููุตูุญุงุช ุงููููุฉ

#### 2. ุจุฑุงูุฌ ุงูููุงุก ูุงูุงุญุชูุงุธ
- ุฅูุดุงุก ุจุฑูุงูุฌ ููุงุท ููุนููุงุก
- ุญููุงุช ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุงููุณุชูุฏูุฉ
- ุนุฑูุถ ุญุตุฑูุฉ ููุนููุงุก ุงูุญุงูููู

## ๐ ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุฑุฆูุณูุฉ (KPIs)

### ูุคุดุฑุงุช ุงููุนู
- ูุฑุงุช ุงูุธููุฑ (Impressions): +500% ุฎูุงู 3 ุฃุดูุฑ
- ุงููุตูู (Reach): +300% ุฎูุงู 3 ุฃุดูุฑ
- ูุนุฏู ุงููุดุงุฑูุฉ: +200% ุฎูุงู ุดูุฑูู

### ูุคุดุฑุงุช ุงูุชุญููู
${data.goals.includes('ูุจูุนุงุช') || data.goals.includes('ุฅูุฑุงุฏุงุช') ? `
**ูููุจูุนุงุช:**
- ุฒูุงุฏุฉ ุงูุฅูุฑุงุฏุงุช: +150% ุฎูุงู 3 ุฃุดูุฑ
- ุชุญุณูู ูุนุฏู ุงูุชุญููู: +75% ุฎูุงู ุดูุฑูู
- ุชูููู ุชูููุฉ ุงูุชุณุงุจ ุงูุนููู: -30%
` : data.goals.includes('ุนููุงุก') || data.goals.includes('ุฌุฐุจ') ? `
**ูุฌุฐุจ ุงูุนููุงุก:**
- ุฒูุงุฏุฉ ุงูุนููุงุก ุงูุฌุฏุฏ: +200% ุฎูุงู 3 ุฃุดูุฑ
- ุชุญุณูู ุฌูุฏุฉ ุงูุนููุงุก ุงููุญุชูููู: +100%
- ุฒูุงุฏุฉ ูุนุฏู ุงูุชุญููู ูู ุฒุงุฆุฑ ูุนููู: +80%
` : `
**ูุคุดุฑุงุช ุนุงูุฉ:**
- ุฒูุงุฏุฉ ุญุฑูุฉ ุงููุฑูุฑ: +250%
- ุชุญุณูู ุฌูุฏุฉ ุงูุฒูุงุฑ: +100%
- ุฒูุงุฏุฉ ุงูุชูุงุนู: +150%
`}

## ๐๏ธ ุงูุฃุฏูุงุช ูุงูุชูููุงุช ุงููุทููุจุฉ

### ุฃุฏูุงุช ุงูุชุญููู
- Google Analytics 4 ูุชุชุจุน ุงูุฃุฏุงุก
- Facebook Pixel ูุชุญููู ุณููู ุงููุณุชุฎุฏููู
- ุฃุฏูุงุช ุชุญููู ุงูููุงูุณูู

### ุฃุฏูุงุช ุงูุฅูุดุงุก
- Canva ุฃู Adobe Creative Suite ููุชุตุงููู
- ุฃุฏูุงุช ุฅูุชุงุฌ ุงูููุฏูู ุงูุจุณูุทุฉ
- ุฃุฏูุงุช ุฌุฏููุฉ ุงููุญุชูู

### ุฃุฏูุงุช ุงูุชุณููู
- ููุตุฉ ุฅุฏุงุฑุฉ ูุณุงุฆู ุงูุชูุงุตู ุงูุงุฌุชูุงุนู
- ูุธุงู ุฅุฏุงุฑุฉ ุนูุงูุงุช ุงูุนููุงุก CRM
- ุฃุฏูุงุช ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุงูุชุณูููู

## ๐ ุงูุฌุฏูู ุงูุฒููู ุงูุชูุตููู

### ุงูุฃุณุจูุน 1-2
- [ ] ุชุญุฏูุฏ ุดุฎุตูุฉ ุงูุนููู ุงููุซุงูู
- [ ] ุฅูุดุงุก ุชูููู ูุญุชูู ูุดูุฑ
- [ ] ุฅุนุฏุงุฏ ุฃุฏูุงุช ุงูุชุชุจุน ูุงูุชุญููู
- [ ] ุชุตููู ุงููุญุชูู ุงูุจุตุฑู ุงูุฃุณุงุณู

### ุงูุฃุณุจูุน 3-4
- [ ] ุฅุทูุงู ุญููุงุช ุงููุนู ุงูุฃููู
- [ ] ุจูุงุก ูุชุงุจุนูู ุนูู ูุณุงุฆู ุงูุชูุงุตู
- [ ] ุฅูุดุงุก ูุญุชูู ุชุนูููู ูุฅุนูุงูู
- [ ] ููุงุณ ุงููุชุงุฆุฌ ุงูุฃูููุฉ

### ุงูุฃุณุจูุน 5-8
- [ ] ุชุญุณูู ุงูุญููุงุช ุจูุงุกู ุนูู ุงูุจูุงูุงุช
- [ ] ุชูุณูุน ุงูุงุณุชูุฏุงู ููุฌูุงููุฑ ุงูุฌุฏูุฏุฉ
- [ ] ุชุทููุฑ ุดุฑุงูุงุช ูุน ุงููุคุซุฑูู
- [ ] ุฅูุดุงุก ูุญุชูู ูุชูุฏู ููุชููุน

### ุงูุฃุณุจูุน 9-12
- [ ] ุชุญููู ุดุงูู ููุฃุฏุงุก
- [ ] ุชุญุณูู ุฑุญูุฉ ุงูุนููู
- [ ] ุฅุทูุงู ุจุฑุงูุฌ ุงูููุงุก
- [ ] ุงูุชุฎุทูุท ูููุฑุญูุฉ ุงูุชุงููุฉ

## ๐ฐ ุงูุชููุนุงุช ุงููุงููุฉ (ุจุนุฏ 3 ุฃุดูุฑ)

${budget > 0 ? `
**ุงูุงุณุชุซูุงุฑ:** ${budget.toLocaleString('ar-EG')} ุฌููู
**ุงูุนุงุฆุฏ ุงููุชููุน:** ${(budget * 3).toLocaleString('ar-EG')} ุฌููู
**ุตุงูู ุงูุฑุจุญ:** ${(budget * 2).toLocaleAndString('ar-EG')} ุฌููู
**ุงูุนุงุฆุฏ ุนูู ุงูุงุณุชุซูุงุฑ (ROI):** 200%
` : `
**ุจูุงุกู ุนูู ุงูุงุณุชุซูุงุฑ ูู ุงูููุช ูุงูุฌูุฏ:**
- ุฒูุงุฏุฉ ุงููุนู ุจุงูุนูุงูุฉ ุงูุชุฌุงุฑูุฉ
- ุจูุงุก ูุงุนุฏุฉ ุนููุงุก ูุฎูุตูู
- ุชุญุณูู ุงูุญุถูุฑ ุงูุฑููู
- ูุถุน ุฃุณุงุณ ููู ููููู ุงููุณุชูุจูู
`}

## โ๏ธ ุงูุชุญุฏูุงุช ุงููุญุชููุฉ ูุงูุญููู

### ุงูุชุญุฏู 1: ุงูููุงูุณุฉ ุงูุดุฏูุฏุฉ
**ุงูุญู:** ุงูุชุฑููุฒ ุนูู ููุงุท ุงูููุฉ ุงููุฑูุฏุฉ ูุงูุงุจุชูุงุฑ

### ุงูุชุญุฏู 2: ุชุบููุฑ ุฎูุงุฑุฒููุงุช ูุณุงุฆู ุงูุชูุงุตู
**ุงูุญู:** ุงูุชูููุน ูู ุงููููุงุช ูุนุฏู ุงูุงุนุชูุงุฏ ุนูู ููุตุฉ ูุงุญุฏุฉ

### ุงูุชุญุฏู 3: ูุญุฏูุฏูุฉ ุงูููุฒุงููุฉ
**ุงูุญู:** ุงูุชุฑููุฒ ุนูู ุงููุญุชูู ุงูุนุถูู ูุงูุดุฑุงูุงุช ุงููุฌุงููุฉ

## ๐ ุฎุทุฉ ุงูุชุทููุฑ ุงููุณุชูุจููุฉ

### ุจุนุฏ 3 ุฃุดูุฑ
- ุชูุณูุน ุงูุฃุณูุงู ุงูุฌุบุฑุงููุฉ
- ุชุทููุฑ ููุชุฌุงุช/ุฎุฏูุงุช ุฌุฏูุฏุฉ
- ุจูุงุก ูุฑูู ุชุณููู ูุชุฎุตุต

### ุจุนุฏ 6 ุฃุดูุฑ
- ุงูุฏุฎูู ูู ูููุงุช ุชุณููู ุฌุฏูุฏุฉ
- ุชุทููุฑ ุชุทุจูู ููุจุงูู
- ุฅูุดุงุก ูุธุงู ุฅุญุงูุฉ ุงูุนููุงุก

### ุจุนุฏ ุณูุฉ
- ููุงุฏุฉ ุงูุณูู ูู ุงููุฌุงู
- ุงูุชูุณุน ุงูุฅููููู
- ุจูุงุก ุฅูุจุฑุงุทูุฑูุฉ ุชุณููููุฉ ุฑูููุฉ

---

## ๐ฏ ุงูุฎุทูุฉ ุงูุชุงููุฉ

ุงุจุฏุฃ ุจุชูููุฐ ุงููุฑุญูุฉ ุงูุฃููู ููุฑุงู! ุงูุชุณููู ุงููุงุฌุญ ูุญุชุงุฌ ููุตุจุฑ ูุงููุซุงุจุฑุฉุ ูููู ุงููุชุงุฆุฌ ุณุชุธูุฑ ุฎูุงู ุงูุฃุณุงุจูุน ุงููุงุฏูุฉ.

**ูุตูุญุฉ ุฐูุจูุฉ:** ุฑุงูุจ ุงููุคุดุฑุงุช ููููุงู ููู ูุณุชุนุฏุงู ููุชููู ูุงูุชุทููุฑ ุญุณุจ ูุง ุชูุธูุฑู ุงูุจูุงูุงุช.`;

        break;

      default:
        strategy = "ููุน ุงูุนูููุฉ ุบูุฑ ูุฏุนูู";
    }

    return NextResponse.json({
      strategy,
      success: true
    });

  } catch (error) {
    console.error('Error in professional strategy API:', error);
    return NextResponse.json({ error: "Internal server error" }, { status: 500 });
  }
}