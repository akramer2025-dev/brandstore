import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function finalSummary() {
  try {
    console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('            ğŸ’° Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ - Ù†Ø¯Ù‰ ğŸ’°');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

    const nadaUser = await prisma.user.findUnique({
      where: { email: 'nada@gmail.com' },
      include: {
        vendor: {
          select: {
            id: true,
            initialCapital: true,
            capitalBalance: true,
          }
        }
      }
    });

    if (!nadaUser?.vendor) {
      console.log('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨ Ù†Ø¯Ù‰');
      return;
    }

    const vendorId = nadaUser.vendor.id;
    const initialCapital = nadaUser.vendor.initialCapital!;
    const currentCapital = nadaUser.vendor.capitalBalance!;

    // Ù…Ø¹Ø§Ù…Ù„Ø§Øª SALE_PROFIT Ø§Ù„Ø®Ø§Ø·Ø¦Ø©
    const wrongSaleProfits = await prisma.capitalTransaction.findMany({
      where: {
        vendorId,
        type: 'SALE_PROFIT',
        descriptionAr: { contains: 'Ø¨ÙŠØ¹ Ø¨Ø¶Ø§Ø¹Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø¸Ø§Ù…' }
      }
    });
    const wrongProfitAmount = wrongSaleProfits.reduce((sum, t) => sum + t.amount, 0);

    // Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ù…Ù„ÙˆÙƒØ©
    const ownedProducts = await prisma.product.findMany({
      where: { vendorId, productSource: 'OWNED' },
      select: {
        supplierCost: true,
        productionCost: true,
        stock: true,
      }
    });
    const ownedStockValue = ownedProducts.reduce((sum, p) => {
      const cost = p.supplierCost || p.productionCost || 0;
      return sum + (cost * (p.stock || 0));
    }, 0);

    // Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„ÙˆØ³Ø·Ø§Ø¡
    const consignmentProducts = await prisma.product.findMany({
      where: { vendorId, productSource: 'CONSIGNMENT' },
      select: {
        id: true,
        nameAr: true,
        supplierCost: true,
        stock: true,
      }
    });
    const consignmentStockValue = consignmentProducts.reduce((sum, p) => {
      const cost = p.supplierCost || 0;
      return sum + (cost * (p.stock || 0));
    }, 0);

    console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
    console.log('â”‚                   ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©              â”‚');
    console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
    console.log(`â”‚ ğŸ’µ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„ÙŠ:             ${initialCapital.toFixed(2)} Ø¬      â”‚`);
    console.log(`â”‚ ğŸ’° Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ (DB):        ${currentCapital.toFixed(2)} Ø¬      â”‚`);
    console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n');

    console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
    console.log('â”‚                   ğŸ›ï¸ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©                       â”‚');
    console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
    console.log(`â”‚ ğŸ“¦ Ø¨Ø¶Ø§Ø¹Ø© Ù…Ù…Ù„ÙˆÙƒØ© (Ù…Ø®Ø²ÙˆÙ†):        ${ownedStockValue.toFixed(2)} Ø¬      â”‚`);
    console.log(`â”‚ ğŸ¤ Ø¨Ø¶Ø§Ø¹Ø© Ù„Ù„ÙˆØ³Ø·Ø§Ø¡ (Ù…Ø®Ø²ÙˆÙ†):       ${consignmentStockValue.toFixed(2)} Ø¬   â”‚`);
    console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n');

    console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
    console.log('â”‚                âš ï¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©                â”‚');
    console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
    console.log(`â”‚ Ø¹Ø¯Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª SALE_PROFIT Ø§Ù„Ø®Ø§Ø·Ø¦Ø©: ${wrongSaleProfits.length}            â”‚`);
    console.log(`â”‚ ğŸ’¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø®Ø§Ø·Ø¦Ø©:       ${wrongProfitAmount.toFixed(2)} Ø¬      â”‚`);
    console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n');

    const correctedCapital = currentCapital - wrongProfitAmount;

    console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
    console.log('â”‚              ğŸ§® Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ù…ØµØ­Ø­                   â”‚');
    console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
    console.log(`â”‚ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ:                ${currentCapital.toFixed(2)} Ø¬      â”‚`);
    console.log(`â”‚ - Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø®Ø§Ø·Ø¦Ø©:                ${wrongProfitAmount.toFixed(2)} Ø¬      â”‚`);
    console.log('â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚');
    console.log(`â”‚ = Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ù…ØµØ­Ø­:              ${correctedCapital.toFixed(2)} Ø¬      â”‚`);
    console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n');

    // Ø§Ù„Ø­Ø³Ø§Ø¨ Ø­Ø³Ø¨ Ù…Ø§ Ù‚Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('           ğŸ“ Ø­Ø³Ø¨ Ù…Ø§ Ø°ÙƒØ±Øª ÙÙŠ Ø£ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

    console.log('   Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„ÙŠ:          7500 Ø¬');
    console.log('   - Ø¨Ø¶Ø§Ø¹Ø© Ù…Ù…Ù„ÙˆÙƒØ©:            1375 Ø¬  âœ…');
    console.log('   - Ø¨Ø¶Ø§Ø¹Ø© Ù„Ù„ÙˆØ³Ø·Ø§Ø¡:           2661 Ø¬  âŒ (Ù„ÙƒÙ† ÙÙŠ DB: 13829 Ø¬!)');
    console.log('   - Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ³Ø·Ø§Ø¡ (Ù…Ø¹Ù„Ù‚Ø©):    2530 Ø¬  (Ù„Ù… Ù†Ø¬Ø¯Ù‡Ø§ ÙÙŠ soldCount)\n');
    console.log('   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
    console.log('   = Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø­Ø³Ø¨ ÙƒÙ„Ø§Ù…Ùƒ:       3464 Ø¬\n');
    console.log('   ğŸ’° Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ù…ØµØ­Ø­ Ø§Ù„ÙØ¹Ù„ÙŠ: 5419 Ø¬\n');
    console.log('   ğŸ“Š Ø§Ù„ÙØ±Ù‚:                   1955 Ø¬\n');

    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('                  ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ±Ù‚');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

    console.log('âš ï¸ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© Ù„Ù„ÙØ±Ù‚:\n');
    console.log('1. Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„ÙˆØ³Ø·Ø§Ø¡ ÙÙŠ DB (13829 Ø¬) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (2661 Ø¬)');
    console.log('   ğŸ’¡ Ø§Ù„Ø³Ø¨Ø¨: Ø±Ø¨Ù…Ø§ Ø¨Ø¹Ø¶ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ù„ÙŠØ³Øª Ù…Ø³Ø¯Ø¯Ø© Ø¨Ø¹Ø¯\n');

    console.log('2. Ø¨Ø¶Ø§Ø¹Ø© Ù„Ù„ÙˆØ³Ø·Ø§Ø¡ Ù…Ø¨Ø§Ø¹Ø© (2530 Ø¬) Ù„Ù… Ù†Ø¬Ø¯Ù‡Ø§ ÙÙŠ soldCount');
    console.log('   ğŸ’¡ Ø§Ù„Ø³Ø¨Ø¨: ÙƒØ§Ù†Øª ØªØ³ØªØ®Ø¯Ù… Ù†Ø¸Ø§Ù… Ù‚Ø¯ÙŠÙ… Ø®Ø§Ø±Ø¬ Product model\n');

    console.log('3. Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ù‚Ø¯ÙŠÙ…Ø© (DEPOSIT/WITHDRAWAL) ØºÙŠØ± Ø¯Ù‚ÙŠÙ‚Ø©\n');

    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n');

    console.log('âœ… Ø§Ù„Ø­Ù„:\n');
    console.log('1. Ø­Ø°Ù Ù…Ø¹Ø§Ù…Ù„Ø§Øª SALE_PROFIT Ø§Ù„Ø®Ø§Ø·Ø¦Ø© (1950 Ø¬)');
    console.log('2. ØªØ­Ø¯ÙŠØ« Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ù…Ù† 7369 Ø¬ Ø¥Ù„Ù‰ 5419 Ø¬\n');

    console.log('ğŸ’¾ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„ÙˆØ³Ø·Ø§Ø¡ (Product model):\n');
    consignmentProducts.forEach((p, i) => {
      const cost = p.supplierCost || 0;
      const value = cost * (p.stock || 0);
      if (value > 0) {
        console.log(`   ${i + 1}. ${p.nameAr}: ${p.stock} Ã— ${cost} = ${value.toFixed(2)} Ø¬`);
      }
    });

    console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£:', error);
  } finally {
    await prisma.$disconnect();
  }
}

finalSummary();
